<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DM Neuro PT">

    <!-- Icon Integration -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-180.png">

    <title>DM Neuro Physiotherapy Centre</title>
    
    <!-- React & Tailwind -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'SF Pro Display', 'Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            red: '#FF3B30',
                            green: '#34C759',
                            orange: '#FF9500',
                            purple: '#AF52DE',
                            gray: '#8E8E93',
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.1)',
                        'glass-sm': '0 4px 16px 0 rgba(31, 38, 135, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern iOS Mesh Gradient Background */
        body { 
            background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-color: #0f172a; 
            background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
            color: #1f2937; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            user-select: none; 
            font-family: 'SF Pro Display', -apple-system, sans-serif;
        }

        .app-container {
            background: radial-gradient(circle at 50% -20%, #e0e7ff 0%, #f3f4f6 40%, #ffffff 100%);
            min-height: 100vh;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .glass-modal {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
        }

        /* Animations */
        .page-enter { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal-enter { animation: slideUp 0.5s cubic-bezier(0.19, 1, 0.22, 1); }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .ios-btn:active { transform: scale(0.96); opacity: 0.8; transition: transform 0.1s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useContext, createContext, useRef, Component } = React;

        // --- ERROR BOUNDARY (Prevents white screen crashes) ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("App Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center text-gray-800 flex flex-col items-center justify-center h-screen bg-gray-100">
                            <h2 className="text-xl font-bold mb-2">Something went wrong.</h2>
                            <p className="mb-4 text-sm text-gray-500">The app encountered an unexpected error.</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg">
                                Reset App Data
                            </button>
                            <pre className="mt-4 text-[10px] text-gray-400 text-left w-full overflow-auto p-2 bg-gray-200 rounded">{this.state.error?.toString()}</pre>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- ICONS ---
        const Icons = {
            Home: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
            Users: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
            Chart: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
            Settings: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
            Plus: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M12 4v16m8-8H4"/></svg>,
            Close: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M6 18L18 6M6 6l12 12"/></svg>,
            Trash: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
            Search: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
            Check: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M5 13l4 4L19 7"/></svg>,
            Lock: <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
            ChevronRight: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M9 5l7 7-7 7"/></svg>,
            Share: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>,
            Tools: <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>,
            ExternalLink: <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>,
            Cloud: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>,
            Download: <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
            WhatsApp: <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" /></svg>
        };

        // --- UTILITIES ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        const formatCurrency = (val) => 'â‚¹' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(val || 0);
        const getToday = () => new Date().toLocaleDateString('en-CA');
        const formatDate = (d) => {
            if (!d) return '';
            return new Date(d + 'T12:00:00').toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        // --- DATA CONTEXT (Safe Loading) ---
        const AppContext = createContext();

        const useStickyState = (key, defaultValue) => {
            const [value, setValue] = useState(() => {
                try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                } catch (error) {
                    console.error(`Error parsing localStorage for ${key}`, error);
                    return defaultValue;
                }
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        const AppProvider = ({ children }) => {
            const [visits, setVisits] = useStickyState('np_visits', []);
            const [expenses, setExpenses] = useStickyState('np_expenses', []);
            const [settings, setSettings] = useStickyState('np_settings', { 
                pin: '0000', 
                doctorName: 'Dr. Kiran Madhav T',
                googleSheetUrl: ''
            });

            const addVisit = (visit) => setVisits(prev => [{...visit, id: generateId(), timestamp: Date.now()}, ...prev]);
            const updateVisit = (visit) => setVisits(prev => prev.map(v => v.id === visit.id ? visit : v));
            const deleteVisit = (id) => setVisits(prev => prev.filter(v => v.id !== id));
            const addExpense = (exp) => setExpenses(prev => [{...exp, id: generateId()}, ...prev]);
            const deleteExpense = (id) => setExpenses(prev => prev.filter(e => e.id !== id));

            const resetAll = () => {
                if(confirm("This will delete ALL data locally. Are you sure?")) {
                    setVisits([]); setExpenses([]);
                    setSettings({ pin: '0000', doctorName: 'Dr. Kiran Madhav T', googleSheetUrl: '' });
                    localStorage.clear();
                    window.location.reload();
                }
            };
            
            const syncToCloud = async () => {
                if(!settings.googleSheetUrl) return alert("Please set Google Sheets Web App URL in Settings.");
                try {
                    await fetch(settings.googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ visits, expenses, timestamp: Date.now() })
                    });
                    alert("Sync request sent! (Check your Google Sheet)");
                } catch (e) {
                    alert("Sync failed: " + e.message);
                }
            };

            return (
                <AppContext.Provider value={{ visits, expenses, settings, setSettings, addVisit, updateVisit, deleteVisit, addExpense, deleteExpense, resetAll, syncToCloud }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- UI COMPONENTS ---
        const Card = ({ children, className = "" }) => (
            <div className={`glass-panel rounded-[24px] p-5 ${className}`}>{children}</div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-md pointer-events-auto transition-opacity duration-300" onClick={onClose}></div>
                    <div className="glass-modal w-full sm:max-w-lg h-[90vh] sm:h-auto sm:rounded-[36px] rounded-t-[36px] shadow-2xl pointer-events-auto transform transition-transform modal-enter flex flex-col overflow-hidden relative">
                        <div className="absolute top-3 left-0 right-0 flex justify-center pointer-events-none">
                            <div className="w-12 h-1.5 bg-gray-300/50 rounded-full backdrop-blur-sm"></div>
                        </div>
                        <div className="flex justify-between items-center p-5 pt-8 border-b border-gray-200/30">
                            <button onClick={onClose} className="text-ios-blue font-medium px-2 active:opacity-60 text-[17px]">Cancel</button>
                            <span className="font-semibold text-gray-900 tracking-tight text-[17px]">{title}</span>
                            <div className="w-12"></div> 
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 pb-20 no-scrollbar space-y-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const InputGroup = ({ label, children }) => (
            <div className="mb-4">
                <label className="block text-[13px] font-semibold text-gray-500 uppercase tracking-wide mb-2 ml-4 opacity-80">{label}</label>
                <div className="glass-panel rounded-[20px] overflow-hidden !p-0 !border-white/40">
                    <div className="divide-y divide-gray-200/40">
                        {children}
                    </div>
                </div>
            </div>
        );

        const Input = (props) => (
            <input {...props} className="w-full p-4 text-[17px] outline-none bg-transparent placeholder-gray-400 font-sans text-gray-800" />
        );

        const Select = ({ options, ...props }) => (
            <div className="relative">
                <select {...props} className="w-full p-4 text-[17px] outline-none bg-transparent appearance-none font-sans text-gray-800">
                    {options.map(o => <option key={o} value={o}>{o}</option>)}
                </select>
                <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                    <svg width="12" height="20" viewBox="0 0 12 20" fill="none"><path d="M2 8L6 12L10 8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                </div>
            </div>
        );

        // --- VIEWS ---
        const LockScreen = ({ onUnlock, pin, onReset }) => {
            const [input, setInput] = useState('');
            const targetPin = pin || '0000';
            const [shaking, setShaking] = useState(false);

            useEffect(() => {
                if (input.length >= targetPin.length) {
                    if (input === targetPin) onUnlock();
                    else {
                        if (navigator.vibrate) navigator.vibrate(200);
                        setShaking(true);
                        setTimeout(() => { setInput(''); setShaking(false); }, 400);
                    }
                }
            }, [input, targetPin, onUnlock]);

            const handleNum = (n) => { if (input.length < targetPin.length) setInput(prev => prev + n); };

            return (
                <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center p-6 bg-black/40 backdrop-blur-3xl text-white">
                    <div className="absolute inset-0 -z-10 bg-gradient-to-b from-black/20 to-black/60"></div>
                    <div className="mb-12 text-center">
                        <div className="w-24 h-24 bg-white/10 rounded-[28px] flex items-center justify-center mx-auto mb-6 backdrop-blur-xl border border-white/20 shadow-2xl">
                            {React.cloneElement(Icons.Lock, { width: 40, height: 40 })}
                        </div>
                        <h2 className="text-2xl font-semibold tracking-tight text-white/90">DM Neuro Physiotherapy Centre</h2>
                        <p className="text-white/60 text-[15px] mt-2 font-medium">Enter Passcode</p>
                    </div>
                    <div className={`flex gap-6 mb-16 h-4 items-center transition-transform ${shaking ? 'translate-x-[-10px]' : ''}`}>
                        {[0,1,2,3].map(i => (
                            <div key={i} className={`w-3.5 h-3.5 rounded-full transition-all duration-300 ${input.length > i ? 'bg-white shadow-[0_0_12px_rgba(255,255,255,0.8)] scale-110' : 'bg-transparent border-[1.5px] border-white/30'}`}></div>
                        ))}
                    </div>
                    <div className="grid grid-cols-3 gap-x-8 gap-y-6 max-w-[300px] w-full">
                        {[1,2,3,4,5,6,7,8,9, '', 0].map((n, i) => (
                            n !== '' ? (
                                <button key={n} onClick={() => handleNum(n)} className="w-[78px] h-[78px] rounded-full bg-white/10 hover:bg-white/20 active:bg-white/40 text-[32px] font-light transition-all backdrop-blur-md mx-auto flex items-center justify-center border border-white/10 shadow-lg">{n}</button>
                            ) : <div key={i}></div>
                        ))}
                        <button onClick={() => setInput(prev => prev.slice(0, -1))} className="flex items-center justify-center text-[15px] font-medium tracking-tight text-white/70 active:text-white transition-colors">Delete</button>
                    </div>
                    <button onClick={onReset} className="mt-12 text-[13px] text-white/40 hover:text-white/80 transition-colors font-medium">Forgot Passcode?</button>
                </div>
            );
        };

        const Dashboard = ({ onNewVisit }) => {
            const { visits } = useContext(AppContext);
            const today = getToday();
            const stats = useMemo(() => {
                const todayVisits = visits.filter(v => v.date === today);
                const revenue = todayVisits.reduce((sum, v) => sum + (parseFloat(v.fee) || 0), 0);
                return { count: todayVisits.length, revenue };
            }, [visits, today]);
            const activePackages = useMemo(() => {
                const purchases = visits.filter(v => v.isPackagePurchase);
                return purchases.map(pkg => {
                    const used = visits.filter(v => v.packageId === pkg.packageId && v.paymentMode === 'Package Visit').length;
                    return { ...pkg, used, total: parseInt(pkg.totalSessions || 10) };
                }).filter(pkg => pkg.used < pkg.total);
            }, [visits]);

            return (
                <div className="p-6 space-y-6 page-enter pb-32 pt-safe">
                    <div className="flex justify-between items-end mb-2 px-1">
                        <div>
                            <p className="text-gray-500 text-[13px] font-bold uppercase mb-1 tracking-wide opacity-80">{formatDate(new Date())}</p>
                            <h1 className="text-[36px] font-bold text-gray-900 leading-tight tracking-tight drop-shadow-sm">Today</h1>
                        </div>
                        <div className="w-11 h-11 glass-panel !p-0 rounded-full flex items-center justify-center border border-white/60 shadow-sm"><span className="font-bold text-gray-500 text-xs">KM</span></div>
                    </div>
                    {/* CHANGED: md:grid-cols-4 for better iPad scaling */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <Card className="hover:bg-white/40 transition-colors"><div className="text-gray-500 text-[11px] font-bold uppercase mb-2 tracking-wider">Revenue</div><div className="text-[28px] font-semibold text-gray-900 tracking-tight">{formatCurrency(stats.revenue)}</div></Card>
                        <Card className="hover:bg-white/40 transition-colors"><div className="text-gray-500 text-[11px] font-bold uppercase mb-2 tracking-wider">Patients</div><div className="text-[28px] font-semibold text-gray-900 tracking-tight">{stats.count}</div></Card>
                    </div>
                    <button onClick={onNewVisit} className="w-full bg-ios-blue/90 backdrop-blur-sm text-white p-4 rounded-[22px] font-semibold text-[17px] shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 ios-btn active:scale-[0.98] transition-all border border-white/20"><span className="text-2xl font-light mb-0.5">+</span> New Consultation</button>
                    {activePackages.length > 0 && <div>
                        <h3 className="text-lg font-bold text-gray-900 mb-3 px-1 opacity-90">Active Packages</h3>
                        {/* CHANGED: Grid layout for packages on iPad */}
                        <div className="space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4">{activePackages.map(pkg => (
                            <Card key={pkg.id} className="relative overflow-hidden !p-0 !bg-white/70">
                                <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-ios-purple"></div>
                                <div className="p-5 pl-6">
                                    <div className="flex justify-between items-start mb-3"><div><div className="font-bold text-[17px] text-gray-900">{pkg.name}</div><div className="text-[13px] text-gray-500 font-medium">{pkg.treatment}</div></div><div className="text-[11px] font-bold text-ios-purple bg-purple-100/50 px-3 py-1 rounded-full border border-purple-200/50">{pkg.used} / {pkg.total}</div></div>
                                    <div className="w-full bg-gray-200/50 rounded-full h-1.5 overflow-hidden"><div className="bg-ios-purple h-1.5 rounded-full transition-all duration-500 shadow-[0_0_8px_rgba(175,82,222,0.6)]" style={{ width: `${(pkg.used/pkg.total)*100}%` }}></div></div>
                                </div>
                            </Card>
                        ))}</div>
                    </div>}
                    <div>
                        <div className="flex justify-between items-center mb-3 px-1"><h3 className="text-lg font-bold text-gray-900 opacity-90">Recent Activity</h3></div>
                        <div className="glass-panel !p-0 rounded-[24px] overflow-hidden"><div className="divide-y divide-gray-200/40">
                            {visits.slice(0, 5).map(v => (
                                <div key={v.id} className="p-4 flex justify-between items-center active:bg-white/40 transition-colors">
                                    <div className="flex items-center gap-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md ${v.fee == 0 ? 'bg-ios-green' : 'bg-ios-blue'}`}>{v.name.charAt(0)}</div><div><div className="font-semibold text-gray-900 text-[16px]">{v.name}</div><div className="text-[13px] text-gray-500">{v.treatment}</div></div></div>
                                    <div className="font-semibold text-gray-900 text-[16px]">{v.fee == 0 ? 'Pkg' : formatCurrency(v.fee)}</div>
                                </div>
                            ))}
                            {visits.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">No activity today</div>}
                        </div></div>
                    </div>
                </div>
            );
        };

        const PatientList = ({ onEdit }) => {
            const { visits } = useContext(AppContext);
            const [search, setSearch] = useState('');
            const filtered = useMemo(() => {
                const s = search.toLowerCase();
                return visits.filter(v => 
                    v.name.toLowerCase().includes(s) || 
                    (v.phone && v.phone.includes(s)) ||
                    (v.address && v.address.toLowerCase().includes(s))
                ).sort((a,b) => b.timestamp - a.timestamp);
            }, [visits, search]);

            const openWhatsApp = (v) => {
                if(v.phone) {
                    window.open(`https://wa.me/91${v.phone}`, '_blank');
                } else {
                    alert("No phone number available for this patient.");
                }
            };

            return (
                <div className="p-6 pb-32 pt-safe page-enter min-h-screen flex flex-col">
                    <h1 className="text-[34px] font-bold text-gray-900 mb-4 tracking-tight px-1 drop-shadow-sm">Patients</h1>
                    <div className="glass-input p-2.5 rounded-[18px] mb-6 flex items-center gap-2 sticky top-4 z-10 shadow-glass-sm"><span className="text-gray-500 pl-2">{Icons.Search}</span><input type="text" placeholder="Name, Phone, or Address" className="flex-1 outline-none bg-transparent text-gray-800 placeholder-gray-500 text-[17px]" value={search} onChange={e => setSearch(e.target.value)} />{search && <button onClick={() => setSearch('')} className="text-gray-400">{Icons.Close}</button>}</div>
                    <div className="space-y-3">
                        {filtered.map(v => (
                            <div key={v.id} className="glass-panel !p-4 rounded-[20px] flex justify-between items-center hover:bg-white/60">
                                <div onClick={() => onEdit(v)} className="flex-1 cursor-pointer">
                                    <div className="font-bold text-gray-900 text-[17px]">{v.name}</div>
                                    <div className="text-[13px] text-gray-500 mt-0.5 font-medium">{formatDate(v.date)} â€¢ {v.treatment}</div>
                                    {v.address && <div className="text-[11px] text-gray-400 mt-0.5 truncate max-w-[200px]">{v.address}</div>}
                                    {v.referralSource === 'Dr. Venkat Reddy' && <div className="inline-block mt-2 bg-orange-100/50 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded border border-orange-200/40">Dr. Venkat</div>}
                                </div>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => openWhatsApp(v)} className="w-9 h-9 rounded-full bg-green-50 text-green-600 flex items-center justify-center active:scale-90 transition-transform">
                                        {Icons.WhatsApp}
                                    </button>
                                    <div onClick={() => onEdit(v)} className="text-gray-400/70 cursor-pointer">{Icons.ChevronRight}</div>
                                </div>
                            </div>
                        ))}
                        {filtered.length === 0 && <div className="text-center text-gray-400 mt-10 text-[15px]">No patients found</div>}
                    </div>
                </div>
            );
        };

        const ToolsView = ({ toolPaths }) => {
            const { visits } = useContext(AppContext);
            const recentPatient = useMemo(() => visits.length > 0 ? visits[0] : null, [visits]);
            const tools = [
                { name: "Extremities & Spine", file: toolPaths.extremities, color: "bg-gradient-to-br from-blue-400 to-blue-600" },
                { name: "Neuro", file: toolPaths.neuro, color: "bg-gradient-to-br from-purple-400 to-purple-600" },
                { name: "Osteopath", file: toolPaths.osteopath, color: "bg-gradient-to-br from-orange-400 to-orange-600" },
                { name: "Physio + Osteo", file: toolPaths.physioOsteo, color: "bg-gradient-to-br from-green-400 to-green-600" },
                { name: "Assessment + Regional Interdependence", file: toolPaths.regional, color: "bg-gradient-to-br from-indigo-400 to-indigo-600" },
            ];
            const launchTool = (filename) => {
                let url = filename;
                if(recentPatient) { const params = new URLSearchParams({ patientId: recentPatient.id, name: recentPatient.name, age: recentPatient.age, sex: recentPatient.sex }); url += `?${params.toString()}`; }
                window.open(url, '_blank');
            };
            
            const sendToolWhatsApp = (toolName) => {
                if(recentPatient && recentPatient.phone) {
                    const text = `Hi ${recentPatient.name}, please complete the ${toolName} assessment.`;
                    window.open(`https://wa.me/91${recentPatient.phone}?text=${encodeURIComponent(text)}`, '_blank');
                } else {
                    alert("No recent patient found with a phone number.");
                }
            };

            return (
                <div className="p-6 pb-32 pt-safe page-enter">
                    <h1 className="text-[34px] font-bold text-gray-900 mb-6 tracking-tight px-1 drop-shadow-sm">Clinical Tools</h1>
                    {recentPatient && <div className="mb-6 p-4 bg-blue-50/40 rounded-[22px] border border-blue-100/50 flex items-center gap-3 backdrop-blur-sm"><div className="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-[13px] shadow-sm">{recentPatient.name.charAt(0)}</div><div className="text-[13px] text-blue-800">Recent patient: <span className="font-bold">{recentPatient.name}</span></div></div>}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {tools.map((t, i) => (
                            <div key={i} className="glass-panel !p-4 rounded-[22px] flex items-center justify-between active:scale-[0.99] transition-all hover:bg-white/60">
                                <button onClick={() => launchTool(t.file)} className="flex items-center gap-5 flex-1 text-left">
                                    <div className={`w-12 h-12 rounded-[16px] ${t.color} text-white flex items-center justify-center shadow-lg ring-1 ring-white/20`}>{Icons.Tools}</div>
                                    <div><div className="font-bold text-gray-900 text-[17px]">{t.name}</div><div className="text-[13px] text-gray-500 font-medium">Launch Assessment</div></div>
                                </button>
                                {recentPatient && (
                                    <button onClick={() => sendToolWhatsApp(t.name)} className="ml-2 w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center active:scale-90 transition-transform">
                                        {Icons.WhatsApp}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Reports = () => {
            const { visits, expenses } = useContext(AppContext);
            const [period, setPeriod] = useState('Daily');
            const report = useMemo(() => {
                const getKey = (dateStr) => period === 'Daily' ? dateStr : dateStr.slice(0, 7);
                const grouped = {};
                visits.forEach(v => { const k = getKey(v.date); if(!grouped[k]) grouped[k]={inc:0,exp:0,label:k}; grouped[k].inc+=parseFloat(v.fee)||0; });
                expenses.forEach(e => { const k = getKey(e.date); if(!grouped[k]) grouped[k]={inc:0,exp:0,label:k}; grouped[k].exp+=parseFloat(e.amount)||0; });
                return Object.values(grouped).sort((a,b) => b.label.localeCompare(a.label));
            }, [visits, expenses, period]);
            
            const shareReport = () => {
                let text = "";
                if(period === 'Daily') {
                    const today = getToday();
                    const todayData = report.find(r => r.label === today) || { inc: 0, exp: 0 };
                    const net = todayData.inc - todayData.exp;
                    text = `ðŸ“Š *Daily Revenue Report (${formatDate(today)})*\n\nðŸ’° Income: ${formatCurrency(todayData.inc)}\nðŸ’¸ Expense: ${formatCurrency(todayData.exp)}\nðŸ“ˆ *Net Profit: ${formatCurrency(net)}*`;
                } else {
                    const currentMonth = getToday().slice(0, 7);
                    const monthData = report.find(r => r.label === currentMonth) || { inc: 0, exp: 0 };
                    const net = monthData.inc - monthData.exp;
                    text = `ðŸ“Š *Monthly Revenue Report (${currentMonth})*\n\nðŸ’° Income: ${formatCurrency(monthData.inc)}\nðŸ’¸ Expense: ${formatCurrency(monthData.exp)}\nðŸ“ˆ *Net Profit: ${formatCurrency(net)}*`;
                }
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            };

            const maxVal = Math.max(...report.map(r => Math.max(r.inc, r.exp)), 100);
            const Bar = ({ val, max, color }) => <div className={`w-2.5 rounded-t-full ${color}`} style={{ height: Math.max((val/max)*100, 5) + '%' }}></div>;
            return (
                <div className="p-6 pb-32 pt-safe page-enter">
                    <div className="flex justify-between items-end mb-4 px-1">
                        <h1 className="text-[34px] font-bold text-gray-900 tracking-tight drop-shadow-sm mb-0">Reports</h1>
                        <button onClick={shareReport} className="bg-green-50 text-green-600 p-2 rounded-full mb-2 active:scale-90 transition-transform">
                            {Icons.Share}
                        </button>
                    </div>
                    <div className="glass-input p-1 rounded-[14px] flex mb-8">{['Daily', 'Monthly'].map(p => <button key={p} onClick={() => setPeriod(p)} className={`flex-1 py-1.5 text-[13px] font-semibold rounded-[11px] transition-all ${period === p ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'}`}>{p}</button>)}</div>
                    <Card className="mb-6"><h3 className="text-[11px] font-bold text-gray-400 uppercase mb-4 tracking-wider">Financial Overview</h3><div className="flex items-end justify-between h-40 gap-3 px-2">{report.slice(0, 7).reverse().map((r, i) => (<div key={i} className="flex flex-col items-center gap-2 h-full justify-end"><div className="flex gap-1.5 items-end h-full"><Bar val={r.inc} max={maxVal} color="bg-ios-blue shadow-[0_0_8px_rgba(0,122,255,0.4)]" /><Bar val={r.exp} max={maxVal} color="bg-ios-red shadow-[0_0_8px_rgba(255,59,48,0.4)]" /></div><div className="text-[10px] text-gray-400 font-medium">{r.label.split('-').pop()}</div></div>))}{report.length === 0 && <div className="w-full text-center text-gray-400 text-sm">No Data</div>}</div></Card>
                    <div className="glass-panel !p-0 rounded-[24px] overflow-hidden">
                        <div className="p-4 bg-gray-50/30 border-b border-gray-200/30 flex text-[11px] font-bold text-gray-500 uppercase tracking-wider backdrop-blur-sm"><div className="flex-1">Date</div><div className="w-20 text-right text-ios-blue">Inc</div><div className="w-20 text-right text-ios-red">Exp</div><div className="w-20 text-right">Net</div></div>
                        <div className="divide-y divide-gray-200/40">{report.map((r, i) => (<div key={i} className="p-4 flex text-[13px] items-center"><div className="flex-1 font-semibold text-gray-800">{r.label}</div><div className="w-20 text-right text-gray-600 font-medium">{formatCurrency(r.inc)}</div><div className="w-20 text-right text-gray-400 font-medium">{formatCurrency(r.exp)}</div><div className={`w-20 text-right font-bold ${r.inc - r.exp >= 0 ? 'text-ios-green' : 'text-ios-red'}`}>{formatCurrency(r.inc - r.exp)}</div></div>))}</div>
                    </div>
                </div>
            );
        };

        const Settings = ({ onReset, toolPaths, onUpdateToolPath }) => {
            const { visits, expenses, settings, setSettings, syncToCloud } = useContext(AppContext);
            const [pathInputs, setPathInputs] = useState(toolPaths);
            
            const handleBackup = () => {
                const data = JSON.stringify({ visits, expenses, settings, date: new Date().toISOString() });
                const blob = new Blob([data], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `NeuroManager_Backup_${getToday()}.json`; a.click();
            };
            const handleRestore = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(confirm('Overwrite current data?')) {
                            localStorage.setItem('np_visits', JSON.stringify(data.visits || []));
                            localStorage.setItem('np_expenses', JSON.stringify(data.expenses || []));
                            localStorage.setItem('np_settings', JSON.stringify(data.settings || settings));
                            window.location.reload();
                        }
                    } catch { alert('Invalid File'); }
                }; reader.readAsText(file);
            };
            
            const handleSavePaths = () => {
                onUpdateToolPath(pathInputs);
                alert("Tool Paths Saved!");
            }

            return (
                <div className="p-6 pb-32 pt-safe page-enter">
                    <h1 className="text-[34px] font-bold text-gray-900 mb-6 tracking-tight px-1 drop-shadow-sm">Settings</h1>
                    <div className="grid md:grid-cols-2 gap-6">
                        <div>
                            <InputGroup label="Clinic Details"><div className="p-4 flex items-center justify-between"><span className="text-[17px] text-gray-900">Doctor Name</span><input className="text-right outline-none bg-transparent text-gray-500 placeholder-gray-400 font-sans text-[17px]" value={settings.doctorName} onChange={e => setSettings({...settings, doctorName: e.target.value})} /></div></InputGroup>
                            <InputGroup label="Cloud Sync (Google Sheets)"><div className="p-4 border-b border-gray-200/40"><input className="w-full outline-none bg-transparent text-gray-600 placeholder-gray-400 font-mono text-[13px]" placeholder="Paste Google Apps Script Web App URL here..." value={settings.googleSheetUrl} onChange={e => setSettings({...settings, googleSheetUrl: e.target.value})} /></div><button onClick={syncToCloud} className="w-full text-left p-4 text-ios-blue active:bg-blue-50/50 transition-colors flex items-center gap-2 font-medium text-[17px]">{Icons.Cloud} Sync Now</button></InputGroup>
                            <InputGroup label="Security"><div className="p-4 flex items-center justify-between"><span className="text-[17px] text-gray-900">Change PIN</span><input type="tel" maxLength="4" className="text-right outline-none bg-transparent text-gray-500 placeholder-gray-400 w-20 font-mono text-[17px]" value={settings.pin} onChange={e => setSettings({...settings, pin: e.target.value.slice(0, 4)})} /></div></InputGroup>
                        </div>
                        <div>
                            <InputGroup label="Tool Paths Config">
                                <div className="p-4 space-y-3">
                                    <div><label className="text-[10px] text-gray-400 uppercase font-bold">Extremities File</label><input className="w-full bg-gray-50 p-2 rounded text-xs font-mono" value={pathInputs.extremities} onChange={e => setPathInputs({...pathInputs, extremities: e.target.value})} /></div>
                                    <div><label className="text-[10px] text-gray-400 uppercase font-bold">Neuro File</label><input className="w-full bg-gray-50 p-2 rounded text-xs font-mono" value={pathInputs.neuro} onChange={e => setPathInputs({...pathInputs, neuro: e.target.value})} /></div>
                                    <div><label className="text-[10px] text-gray-400 uppercase font-bold">Osteopath File</label><input className="w-full bg-gray-50 p-2 rounded text-xs font-mono" value={pathInputs.osteopath} onChange={e => setPathInputs({...pathInputs, osteopath: e.target.value})} /></div>
                                    <div><label className="text-[10px] text-gray-400 uppercase font-bold">Physio File</label><input className="w-full bg-gray-50 p-2 rounded text-xs font-mono" value={pathInputs.physioOsteo} onChange={e => setPathInputs({...pathInputs, physioOsteo: e.target.value})} /></div>
                                    <div><label className="text-[10px] text-gray-400 uppercase font-bold">Regional File</label><input className="w-full bg-gray-50 p-2 rounded text-xs font-mono" value={pathInputs.regional} onChange={e => setPathInputs({...pathInputs, regional: e.target.value})} /></div>
                                    <button onClick={handleSavePaths} className="bg-ios-blue text-white px-4 py-2 rounded-lg text-xs font-bold w-full">Save Paths</button>
                                </div>
                            </InputGroup>
                            <InputGroup label="Data Management"><button onClick={handleBackup} className="w-full text-left p-4 text-ios-blue active:bg-blue-50/50 transition-colors flex items-center gap-2 font-medium text-[17px]">{Icons.Download} Backup to File (JSON)</button><label className="w-full block text-left p-4 text-ios-blue active:bg-blue-50/50 transition-colors cursor-pointer border-t border-gray-200/40 font-medium text-[17px]">Restore from File<input type="file" className="hidden" accept=".json" onChange={handleRestore} /></label></InputGroup>
                            <button onClick={onReset} className="w-full mt-4 bg-white/70 backdrop-blur-md border border-red-200/60 text-ios-red font-semibold p-4 rounded-[18px] shadow-sm text-[17px] active:bg-red-50/50 transition-colors">Factory Reset App</button>
                        </div>
                    </div>
                    <div className="mt-8 text-center text-[12px] text-gray-400 font-medium opacity-80">DM Neuro Physiotherapy Centre v2.3 <br/> Glassmorphism Edition (iPad Optimized)</div>
                </div>
            );
        };

        const EntryModal = ({ isOpen, onClose, initialData }) => {
            const { addVisit, updateVisit, visits, deleteVisit } = useContext(AppContext);
            const [form, setForm] = useState({ name: '', age: '', sex: 'Male', phone: '', address: '', fee: '', paymentMode: 'Cash', treatment: '', notes: '', referralSource: 'Walk-in', manualTherapy: { dryNeedling: false, kinesio: false, other: '' }, isPackagePurchase: false, totalSessions: 10, usePackage: false, selectedPackageId: '' });

            useEffect(() => {
                if (isOpen) {
                    if (initialData) {
                        const t = initialData.treatment || '';
                        setForm({ ...initialData, manualTherapy: { dryNeedling: t.includes('Dry Needling'), kinesio: t.includes('Kinesio Taping'), other: '' }, usePackage: initialData.paymentMode === 'Package Visit' });
                    } else {
                        setForm({ name: '', age: '', sex: 'Male', phone: '', address: '', fee: '', paymentMode: 'Cash', treatment: '', notes: '', referralSource: 'Walk-in', manualTherapy: { dryNeedling: false, kinesio: false, other: '' }, isPackagePurchase: false, totalSessions: 10, usePackage: false, selectedPackageId: '' });
                    }
                }
            }, [isOpen, initialData]);

            useEffect(() => {
                if (!initialData && form.phone.length > 9) {
                    const existing = visits.find(v => v.phone === form.phone);
                    if (existing) {
                        setForm(prev => ({ ...prev, name: existing.name, age: existing.age || prev.age, sex: existing.sex || prev.sex, address: existing.address || prev.address, referralSource: existing.referralSource || prev.referralSource }));
                    }
                }
            }, [form.phone]);

            const activePackages = useMemo(() => {
                return visits.filter(v => v.isPackagePurchase && v.phone === form.phone).map(pkg => {
                    const used = visits.filter(v => v.packageId === pkg.packageId && v.paymentMode === 'Package Visit').length;
                    return { ...pkg, used, total: parseInt(pkg.totalSessions) };
                }).filter(p => p.used < p.total);
            }, [visits, form.phone]);

            const handleSave = () => {
                if (!form.name || (!form.usePackage && !form.fee)) { alert('Name and Fee are required.'); return; }
                let treatments = [form.treatment];
                if (form.manualTherapy.dryNeedling) treatments.push('Dry Needling');
                if (form.manualTherapy.kinesio) treatments.push('Kinesio Taping');
                if (form.manualTherapy.other) treatments.push(form.manualTherapy.other);
                const treatmentStr = treatments.filter(Boolean).join(', ');
                const finalData = { ...form, treatment: treatmentStr, date: form.date || getToday(), isPackagePurchase: form.paymentMode === 'Package Advance', packageId: form.paymentMode === 'Package Advance' ? generateId() : (form.usePackage ? form.selectedPackageId : null), paymentMode: form.usePackage ? 'Package Visit' : form.paymentMode, fee: form.usePackage ? '0' : form.fee };
                if (initialData) updateVisit(finalData); else addVisit(finalData);
                onClose();
            };
            
            const shareReceipt = () => {
                 if (!form.phone) return alert('Phone number required');
                 const text = `ðŸ§¾ *Payment Receipt*\n*DM Neuro Physiotherapy Centre*\n\nPatient: ${form.name}\nDate: ${getToday()}\nAmount: ${formatCurrency(form.fee)}\nMode: ${form.paymentMode}\n\nThank you!`;
                 window.open(`https://wa.me/91${form.phone}?text=${encodeURIComponent(text)}`, '_blank');
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={initialData ? "Edit Visit" : "New Visit"}>
                    <div className="space-y-6">
                        <InputGroup label="Patient Details"><Input placeholder="Full Name" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /><div className="flex border-t border-gray-200/40"><Input type="tel" placeholder="Phone" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} /><div className="w-[1px] bg-gray-200/40"></div><Input type="number" placeholder="Age" className="w-24 text-center" value={form.age} onChange={e => setForm({...form, age: e.target.value})} /></div><div className="border-t border-gray-200/40"><Select options={['Male', 'Female', 'Other']} value={form.sex} onChange={e => setForm({...form, sex: e.target.value})} /></div></InputGroup>
                        <InputGroup label="Clinical Info"><Select options={['CS', 'LBA', 'PA Shoulder', 'OA Knee', 'Stroke', 'Parkinsons', 'Other']} value={form.treatment} onChange={e => setForm({...form, treatment: e.target.value})} /><div className="p-4 bg-white/40 border-t border-gray-200/40 backdrop-blur-sm"><div className="text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-wider opacity-80">EXTRAS</div><div className="flex gap-2"><button onClick={() => setForm(p => ({...p, manualTherapy: {...p.manualTherapy, dryNeedling: !p.manualTherapy.dryNeedling}}))} className={`px-4 py-2 rounded-xl text-xs font-bold transition-colors ${form.manualTherapy.dryNeedling ? 'bg-ios-blue text-white shadow-md shadow-blue-500/30' : 'bg-white/60 text-gray-600 border border-white/40'}`}>Dry Needling</button><button onClick={() => setForm(p => ({...p, manualTherapy: {...p.manualTherapy, kinesio: !p.manualTherapy.kinesio}}))} className={`px-4 py-2 rounded-xl text-xs font-bold transition-colors ${form.manualTherapy.kinesio ? 'bg-ios-blue text-white shadow-md shadow-blue-500/30' : 'bg-white/60 text-gray-600 border border-white/40'}`}>Kinesio</button></div></div><Input placeholder="Notes / Observations" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} /></InputGroup>
                        {activePackages.length > 0 && !initialData && <div className="mb-4"><label className="flex items-center gap-3 p-4 bg-purple-500/10 rounded-2xl border border-purple-500/20 cursor-pointer transition-colors active:bg-purple-500/20 backdrop-blur-sm"><input type="checkbox" checked={form.usePackage} onChange={e => setForm({...form, usePackage: e.target.checked, selectedPackageId: activePackages[0]?.packageId || ''})} className="w-5 h-5 accent-ios-purple rounded-md" /><span className="font-bold text-ios-purple text-[15px]">Use Active Package ({activePackages[0]?.used}/{activePackages[0]?.total})</span></label></div>}
                        {!form.usePackage && <InputGroup label="Payment"><Input type="number" placeholder="Fee Amount (â‚¹)" value={form.fee} onChange={e => setForm({...form, fee: e.target.value})} /><Select options={['Cash', 'UPI', 'Card', 'Package Advance', 'FOC']} value={form.paymentMode} onChange={e => setForm({...form, paymentMode: e.target.value})} />{form.paymentMode === 'Package Advance' && <div className="p-4 bg-yellow-50/40 border-t border-yellow-200/40 backdrop-blur-sm"><div className="text-[11px] font-bold text-yellow-700 mb-2 uppercase tracking-wider">TOTAL SESSIONS</div><input type="number" className="w-full bg-white/70 p-3 rounded-xl border border-yellow-200/60 outline-none font-sans text-[17px]" value={form.totalSessions} onChange={e => setForm({...form, totalSessions: e.target.value})} /></div>}</InputGroup>}
                        <InputGroup label="Referral"><Select options={['Walk-in', 'Dr. Venkat Reddy', 'Google', 'Other']} value={form.referralSource} onChange={e => setForm({...form, referralSource: e.target.value})} /></InputGroup>
                        <div className="flex gap-4 mt-8">{initialData && <button onClick={() => { if(confirm('Delete record?')) { deleteVisit(initialData.id); onClose(); } }} className="flex-1 bg-red-500/10 text-red-600 font-bold p-4 rounded-2xl active:scale-95 transition-transform text-[17px] border border-red-500/20">Delete</button>}<button onClick={handleSave} className="flex-[2] bg-ios-blue text-white font-bold p-4 rounded-2xl shadow-[0_8px_20px_rgba(0,122,255,0.3)] active:scale-95 transition-transform text-[17px] bg-gradient-to-b from-blue-500 to-blue-600 border-t border-white/20">Save</button></div>
                        {initialData && <button onClick={shareReceipt} className="w-full text-center text-ios-blue font-semibold py-3 active:opacity-60 transition-opacity">Share Receipt on WhatsApp</button>}
                    </div>
                </Modal>
            );
        };

        const App = () => {
            const { settings, resetAll } = useContext(AppContext);
            const [locked, setLocked] = useState(true);
            const [view, setView] = useState('dashboard');
            const [modalOpen, setModalOpen] = useState(false);
            const [editData, setEditData] = useState(null);
            
            // Re-instated Tool Paths State
            const [toolPaths, setToolPaths] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('dm_tool_paths')) || {
                        extremities: 'extremities.html',
                        neuro: 'neuro.html',
                        osteopath: 'osteopath.html',
                        physioOsteo: 'physio_osteo.html',
                        regional: 'assessment_regional.html'
                    };
                } catch {
                    return {
                        extremities: 'extremities.html',
                        neuro: 'neuro.html',
                        osteopath: 'osteopath.html',
                        physioOsteo: 'physio_osteo.html',
                        regional: 'assessment_regional.html'
                    };
                }
            });
            
            useEffect(() => {
                localStorage.setItem('dm_tool_paths', JSON.stringify(toolPaths));
            }, [toolPaths]);

            const openNew = () => { setEditData(null); setModalOpen(true); };
            const openEdit = (data) => { setEditData(data); setModalOpen(true); };

            if (locked) return <LockScreen pin={settings.pin} onUnlock={() => setLocked(false)} onReset={resetAll} />;

            return (
                // CHANGED: Increased max-width to 7xl for iPad friendliness, and set flex layout
                <div className="app-container w-full max-w-7xl mx-auto relative shadow-2xl overflow-hidden border-x border-white/20 h-screen flex flex-col">
                    {/* CHANGED: Content area takes full remaining height */}
                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        {view === 'dashboard' && <Dashboard onNewVisit={openNew} />}
                        {view === 'patients' && <PatientList onEdit={openEdit} />}
                        {view === 'tools' && <ToolsView toolPaths={toolPaths} />}
                        {view === 'reports' && <Reports />}
                        {view === 'settings' && <Settings onReset={resetAll} toolPaths={toolPaths} onUpdateToolPath={setToolPaths} />}
                    </div>
                    {/* CHANGED: Fixed bottom nav bar width to match app container */}
                    <div className="fixed bottom-0 left-0 right-0 mx-auto w-full max-w-7xl glass-nav flex justify-between px-6 pb-safe pt-3 z-40">
                        <TabButton icon={Icons.Home} label="Today" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                        <TabButton icon={Icons.Users} label="Patients" active={view === 'patients'} onClick={() => setView('patients')} />
                        <TabButton icon={Icons.Tools} label="Tools" active={view === 'tools'} onClick={() => setView('tools')} />
                        <TabButton icon={Icons.Chart} label="Reports" active={view === 'reports'} onClick={() => setView('reports')} />
                        <TabButton icon={Icons.Settings} label="Settings" active={view === 'settings'} onClick={() => setView('settings')} />
                    </div>
                    <EntryModal isOpen={modalOpen} onClose={() => setModalOpen(false)} initialData={editData} />
                </div>
            );
        };

        const TabButton = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 p-1 transition-all active:scale-90 ${active ? 'text-ios-blue drop-shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}>
                {React.cloneElement(icon, { width: 26, height: 26, strokeWidth: active ? 2.5 : 2 })}
                <span className="text-[10px] font-medium tracking-tight">{label}</span>
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <AppProvider>
                    <App />
                </AppProvider>
            </ErrorBoundary>
        );
    </script>
</body>
</html>
