<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PhysioPro Assessment</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { ios: { blue: '#007AFF', red: '#FF3B30' } },
                    animation: {
                        blob: "blob 10s infinite",
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" },
                        },
                    },
                }
            }
        }
    </script>
    <style>
        body { background-color: #F2F2F7; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        .draw-cursor { cursor: crosshair; }
        .canvas-stack { position: relative; width: 250px; height: 500px; background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; margin: 0 auto; }
        .bg-outline { position: absolute; inset: 0; pointer-events: none; z-index: 1; opacity: 0.6; }
        .draw-layer { position: relative; z-index: 10; touch-action: none; width: 100%; height: 100%; }
        
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS & CONFIG ---
        const Icon = ({ path, size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{path}</svg>;
        const Icons = {
            Left: <polyline points="15 18 9 12 15 6" />,
            Check: <polyline points="20 6 9 17 4 12" />,
            Printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>
        };

        const ROM_DATA = {
            cervical: { labels: ['Flexion', 'Ext', 'Lat Flex R', 'Lat Flex L', 'Rot R', 'Rot L'], defaults: ['50','60','45','45','80','80'] },
            lumbar: { labels: ['Flexion', 'Ext', 'Side Glide R', 'Side Glide L'], defaults: ['60','25','Normal','Normal'] },
            shoulder: { labels: ['Flexion', 'Abd', 'ER', 'IR'], defaults: ['180','180','90','70'] },
            knee: { labels: ['Flexion', 'Ext'], defaults: ['135','0'] }
        };

        // --- BODY MAP COMPONENT ---
        const BodyMapCanvas = ({ id, bgPath }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                // Important: Set explicit resolution to match CSS display size
                canvas.width = 250; 
                canvas.height = 500;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = "#ef4444"; ctx.lineWidth = 4;
            }, []);

            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const scaleX = canvasRef.current.width / rect.width;
                const scaleY = canvasRef.current.height / rect.height;
                return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
            };

            const start = (e) => { setIsDrawing(true); draw(e); };
            const stop = () => setIsDrawing(false);
            const draw = (e) => {
                if(!isDrawing && e.type !== 'mousedown' && e.type !== 'touchstart') return;
                if(e.type === 'touchmove') e.preventDefault(); 
                
                const ctx = canvasRef.current.getContext('2d');
                const pos = getPos(e);
                
                if(e.type === 'mousedown' || e.type === 'touchstart') {
                    ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
                } else {
                    ctx.lineTo(pos.x, pos.y); ctx.stroke();
                }
            };

            return (
                <div className="canvas-stack relative">
                    <svg className="bg-outline w-full h-full" viewBox="0 0 250 500" xmlns="http://www.w3.org/2000/svg">
                        <g transform="translate(25, 0)">
                            <path d={bgPath} fill="none" stroke="#94a3b8" strokeWidth="2" />
                        </g>
                    </svg>
                    <canvas 
                        ref={canvasRef} 
                        id={id}
                        className="draw-layer draw-cursor block"
                        onMouseDown={start} onMouseMove={draw} onMouseUp={stop} onMouseLeave={stop}
                        onTouchStart={start} onTouchMove={draw} onTouchEnd={stop}
                    />
                </div>
            );
        };

        const AssessmentApp = () => {
            const [tab, setTab] = useState('Intake');
            const [formData, setFormData] = useState({
                name: '', id: '', date: new Date().toISOString().split('T')[0],
                dx: '', cc: '', vas: '0', plan: ''
            });

            // On Mount: Read URL Params
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                setFormData(prev => ({
                    ...prev,
                    name: params.get('name') || '',
                    id: params.get('id') || '',
                    age: params.get('age') || '',
                    sex: params.get('sex') || ''
                }));
            }, []);

            // Paths for Body Map
            const pathFront = "M100,35 C115,35 125,25 125,15 C125,5 115,-5 100,-5 C85,-5 75,5 75,15 C75,25 85,35 100,35 Z M100,45 L100,65 M85,65 L115,65 M115,65 L160,75 L150,150 L165,230 L155,250 M85,65 L40,75 L50,150 L35,230 L45,250 M85,65 L115,65 L125,160 L130,220 L70,220 L75,160 Z M70,220 L130,220 M75,220 L60,350 L80,450 L100,450 M125,220 L140,350 L120,450 L100,450";
            const pathBack = "M100,35 C115,35 125,25 125,15 C125,5 115,-5 100,-5 C85,-5 75,5 75,15 C75,25 85,35 100,35 Z M100,45 L100,65 M85,65 L115,65 M115,65 L160,75 L150,150 L165,230 L155,250 M85,65 L40,75 L50,150 L35,230 L45,250 M85,65 L115,65 L125,140 L130,220 L70,220 L75,140 Z M100,65 L100,220 M70,220 L130,220 M75,220 L60,350 L80,450 L100,450 M125,220 L140,350 L120,450 L100,450";

            const generatePDF = () => {
                const cFront = document.getElementById('canvas-front');
                const cBack = document.getElementById('canvas-back');
                const imgFront = cFront ? cFront.toDataURL() : '';
                const imgBack = cBack ? cBack.toDataURL() : '';

                const printContent = `
                    <div style="font-family: sans-serif; padding: 40px;">
                        <h1 style="color:#2563EB; text-align:center; margin-bottom:5px;">Clinical Assessment</h1>
                        <p style="text-align:center; color:#666;">PhysioPro Reports</p>
                        <p style="text-align:right; font-size:12px;">Date: ${formData.date}</p>
                        
                        <table style="width:100%; margin:20px 0; border-collapse:collapse;">
                            <tr><td style="padding:8px; border:1px solid #eee;"><strong>Patient:</strong> ${formData.name}</td><td style="padding:8px; border:1px solid #eee;"><strong>ID:</strong> ${formData.id}</td></tr>
                            <tr><td colspan="2" style="padding:8px; border:1px solid #eee;"><strong>Diagnosis:</strong> ${formData.dx}</td></tr>
                            <tr><td colspan="2" style="padding:8px; border:1px solid #eee;"><strong>History:</strong> ${formData.cc}</td></tr>
                        </table>

                        <h3 style="color:#2563EB; border-bottom:1px solid #ccc; padding-bottom:5px;">Body Map</h3>
                        <div style="text-align:center; margin:20px 0;">
                            <img src="${imgFront}" style="width:150px; height:300px; border:1px solid #ccc; margin-right:10px;">
                            <img src="${imgBack}" style="width:150px; height:300px; border:1px solid #ccc;">
                        </div>

                        <h3 style="color:#2563EB; border-bottom:1px solid #ccc; padding-bottom:5px;">Treatment Plan</h3>
                        <div style="background:#f9fafb; padding:15px; border-radius:5px;">${formData.plan || 'N/A'}</div>
                        
                        <div style="margin-top:40px; text-align:right;">
                            <p style="border-top:1px solid #000; display:inline-block; padding-top:5px; width:200px; text-align:center;">Therapist Signature</p>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = printContent;
                document.body.appendChild(container);
                html2pdf().set({ margin:10, filename: `${formData.name}_${formData.date}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} })
                    .from(container).save().then(() => document.body.removeChild(container));
            };

            return (
                <div className="h-[100dvh] w-full bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 flex flex-col overflow-hidden relative">
                    {/* Background Animation blobs to match Main App */}
                    <div className="fixed inset-0 pointer-events-none">
                        <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-400/20 rounded-full mix-blend-multiply filter blur-[100px] animate-blob"></div>
                        <div className="absolute top-[20%] right-[-10%] w-[400px] h-[400px] bg-purple-400/20 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-2000"></div>
                        <div className="absolute bottom-[-10%] left-[20%] w-[600px] h-[600px] bg-pink-400/20 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-4000"></div>
                    </div>

                    {/* Header */}
                    <div className="glass-panel sticky top-0 px-4 py-4 flex justify-between items-center z-20 border-b border-white/40">
                        <div>
                            <h1 className="text-xl font-extrabold text-gray-900">Assessment</h1>
                            <p className="text-xs text-gray-500 font-bold">{formData.name} {formData.id ? `(${formData.id})` : ''}</p>
                        </div>
                        <button onClick={generatePDF} className="bg-gray-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg active:scale-95 transition-transform"><Icon path={Icons.Printer} /> PDF</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-24 relative z-10">
                        <div className="flex bg-white/60 p-1 rounded-xl mb-6 shadow-sm">
                            {['Intake', 'Body Map', 'ROM', 'Plan'].map(t => (
                                <button key={t} onClick={() => setTab(t)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${tab === t ? 'bg-white shadow text-ios-blue' : 'text-gray-500'}`}>{t}</button>
                            ))}
                        </div>

                        <div className="space-y-6">
                            {tab === 'Intake' && (
                                <div className="animate-fade-in">
                                    <div className="glass-panel p-4 rounded-2xl space-y-4 mb-4">
                                        <div><label className="text-xs font-bold text-gray-400 uppercase">Diagnosis</label><input type="text" value={formData.dx} onChange={e => setFormData({...formData, dx:e.target.value})} className="w-full bg-transparent border-b border-gray-200 py-2 font-medium outline-none" placeholder="Enter Dx..." /></div>
                                        <div><label className="text-xs font-bold text-gray-400 uppercase">History / Complaint</label><textarea value={formData.cc} onChange={e => setFormData({...formData, cc:e.target.value})} rows="4" className="w-full bg-white/50 rounded-xl p-3 mt-1 text-sm outline-none" placeholder="Subjective..." /></div>
                                    </div>
                                    <div className="glass-panel p-4 rounded-2xl">
                                        <label className="text-xs font-bold text-gray-400 uppercase mb-3 block">VAS Pain Scale: <span className="text-blue-600 text-lg ml-2">{formData.vas}</span></label>
                                        <input type="range" min="0" max="10" value={formData.vas} onChange={e => setFormData({...formData, vas:e.target.value})} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                                        <div className="flex justify-between text-[10px] text-gray-400 mt-1 font-bold"><span>0 (No Pain)</span><span>10 (Severe)</span></div>
                                    </div>
                                </div>
                            )}

                            {tab === 'Body Map' && (
                                <div className="space-y-8 flex flex-col items-center animate-fade-in">
                                    <div className="text-center w-full">
                                        <h4 className="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">Front View</h4>
                                        <BodyMapCanvas id="canvas-front" bgPath={pathFront} />
                                    </div>
                                    <div className="text-center w-full">
                                        <h4 className="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">Back View</h4>
                                        <BodyMapCanvas id="canvas-back" bgPath={pathBack} />
                                    </div>
                                    <p className="text-xs text-gray-400 italic">Use touch or mouse to draw red pain indicators.</p>
                                </div>
                            )}

                            {tab === 'ROM' && (
                                <div className="space-y-4 animate-fade-in">
                                    {Object.keys(ROM_DATA).map(region => (
                                        <div key={region} className="glass-panel p-4 rounded-2xl">
                                            <h3 className="font-bold text-gray-800 uppercase text-sm mb-3 border-b border-gray-100 pb-2">{region}</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                {ROM_DATA[region].labels.map((lbl, i) => (
                                                    <div key={lbl}>
                                                        <label className="text-[10px] font-bold text-gray-400 block mb-1">{lbl}</label>
                                                        <input type="text" placeholder={ROM_DATA[region].defaults[i]} className="w-full bg-white/50 rounded-lg p-2 text-sm outline-none font-medium border border-transparent focus:border-blue-300" />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {tab === 'Plan' && (
                                <div className="glass-panel p-4 rounded-2xl h-full animate-fade-in">
                                    <label className="text-xs font-bold text-gray-400 uppercase block mb-3">Treatment Plan & Goals</label>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {['IFT', 'US', 'Laser', 'Manual Therapy', 'Taping', 'Strengthening', 'Stretching'].map(tag => (
                                            <button key={tag} onClick={() => setFormData(prev => ({...prev, plan: (prev.plan ? prev.plan + ', ' : '') + tag}))} className="px-3 py-1 bg-white border border-gray-200 text-gray-600 rounded-full text-xs font-bold shadow-sm active:scale-95 transition-transform">{tag}</button>
                                        ))}
                                    </div>
                                    <textarea value={formData.plan} onChange={e => setFormData({...formData, plan:e.target.value})} className="w-full h-64 bg-white/50 rounded-xl p-4 text-sm outline-none resize-none" placeholder="Write detailed plan here..." />
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AssessmentApp />);
    </script>
</body>
</html>
