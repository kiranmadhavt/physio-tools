<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PhysioPro Assessment v24 - Fixed & Complete</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { ios: { blue: '#007AFF', red: '#FF3B30', green: '#34C759', yellow: '#FFCC00', teal: '#5AC8FA', dark: '#1c1c1e', purple: '#AF52DE' } },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { "0%": { opacity: "0" }, "100%": { opacity: "1" } },
                        slideUp: { "0%": { transform: "translateY(100%)" }, "100%": { transform: "translateY(0)" } }
                    },
                }
            }
        }
    </script>
    <style>
        body { background-color: #F2F2F7; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .modal-overlay { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }

        /* Gradient Slider */
        input[type=range].vas-slider {
            -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px;
            background: linear-gradient(to right, #34C759 0%, #FFCC00 50%, #FF3B30 100%);
            outline: none; transition: opacity .2s;
        }
        input[type=range].vas-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px;
            border-radius: 50%; background: #ffffff; border: 2px solid #e5e7eb;
            cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        input[type=range].vas-slider::-webkit-slider-thumb:active { transform: scale(1.2); }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIG ---
        const GOOGLE_SCRIPT_URL = localStorage.getItem('dm_sync_url') || "INSERT_YOUR_DEPLOYED_WEB_APP_URL_HERE";

        const Icon = ({ name, size = "text-lg", className = "" }) => <i className={`fa-solid fa-${name} ${size} ${className}`}></i>;

        const RED_FLAGS = ["Cauda Equina Signs", "Saddle Anesthesia", "Unremitting Night Pain", "Unexplained Weight Loss", "History of Cancer", "Recent Trauma", "Fever/Systemic Signs", "Progressive Neuro Deficit"];

        const VISCERO_MAP = [
            { seg: 'T1-T4', organ: 'Heart, Head, Neck' }, { seg: 'T2-T7', organ: 'Lungs' },
            { seg: 'T5-T9', organ: 'Stomach, Liver, GB' }, { seg: 'T10-T11', organ: 'Kidneys, Upper Ureter' },
            { seg: 'T12-L2', organ: 'Lower Ureter, Bladder' }
        ];

        const POSTURE_OPTS = {
            Head: ['Forward Head', 'Tilted R', 'Tilted L'],
            Shoulders: ['Rounded', 'Elevated R', 'Elevated L'],
            Spine: ['Kyphosis', 'Lordosis', 'Scoliosis'],
            Hips: ['Ant. Tilt', 'Post. Tilt', 'Hiked R', 'Hiked L'],
            Knees: ['Valgus', 'Varus', 'Hyperextension']
        };

        const GAIT_OPTS = ['Antalgic', 'Trendelenburg', 'Steppage / Foot Drop', 'Circumduction', 'Short Step Length', 'Ataxic', 'Festinating', 'Scissoring'];

        const ROM_DATA = {
            cervical: [{ id: 'c_flex', label: 'Flexion', norm: '50°' }, { id: 'c_ext', label: 'Extension', norm: '60°' }, { id: 'c_rot_r', label: 'Rot R', norm: '80°' }, { id: 'c_rot_l', label: 'Rot L', norm: '80°' }],
            thoracic: [{ id: 't_rot_r', label: 'Rot R', norm: '50°' }, { id: 't_rot_l', label: 'Rot L', norm: '50°' }],
            lumbar: [{ id: 'l_flex', label: 'Flexion', norm: '60°' }, { id: 'l_ext', label: 'Extension', norm: '25°' }],
            hip: [{ id: 'h_flex', label: 'Flexion', norm: '120°' }, { id: 'h_ir', label: 'Int Rot', norm: '45°' }, { id: 'h_er', label: 'Ext Rot', norm: '45°' }],
            shoulder: [{ id: 's_flex', label: 'Flexion', norm: '180°' }, { id: 's_er', label: 'Ext Rot', norm: '90°' }, { id: 's_ir', label: 'Int Rot', norm: '70°' }],
            elbow: [{ id: 'e_flex', label: 'Flexion', norm: '150°' }, { id: 'e_ext', label: 'Extension', norm: '0°' }, { id: 'e_sup', label: 'Supination', norm: '80°' }, { id: 'e_pro', label: 'Pronation', norm: '80°' }],
            wrist: [{ id: 'w_flex', label: 'Flexion', norm: '80°' }, { id: 'w_ext', label: 'Extension', norm: '70°' }],
            knee: [{ id: 'k_flex', label: 'Flexion', norm: '135°' }, { id: 'k_ext', label: 'Extension', norm: '0°' }],
            ankle: [{ id: 'a_df', label: 'Dorsiflex', norm: '20°' }, { id: 'a_pf', label: 'Plantarflex', norm: '50°' }]
        };

        const CLUSTERS = {
            cervical: { name: "Wainner's (Radic)", tests: [{id:'c_ultt',l:'ULTT A'},{id:'c_spur',l:'Spurlings'},{id:'c_dist',l:'Distraction'},{id:'c_rot',l:'Rot<60'}], rules: [{c:3,t:"Likely Radic",x:"text-red-600"}] },
            cervical_myelopathy: { name: "Cook's (Myelopathy)", tests: [{id:'c_hoff',l:'Hoffmann'},{id:'c_inv',l:'Invert Supinator'},{id:'c_bab',l:'Babinski'},{id:'c_gait',l:'Gait Deviation'},{id:'c_age45',l:'Age > 45'}], rules: [{c:3,t:"POSSIBLE MYELOPATHY",x:"text-red-700 bg-red-100 border-red-300"}] },
            lumbar_stenosis: { name: "Cook's (Stenosis)", tests: [{id:'l_age',l:'>48y'},{id:'l_hist',l:'Leg Pain'},{id:'l_sit',l:'Better Sit'},{id:'l_stand',l:'Worse Stand'}], rules: [{c:4,t:"Likely Stenosis",x:"text-red-600"}] },
            lumbar_instability: { name: "Hicks (Instability)", tests: [{id:'l_prone',l:'Prone Instability'},{id:'l_aberrant',l:'Aberrant Motion'},{id:'l_slr90',l:'SLR > 90'},{id:'l_age40',l:'Age < 40'}], rules: [{c:3,t:"Likely Instability",x:"text-orange-500"}] },
            sij: { name: "Laslett's (SIJ)", tests: [{id:'s_dist',l:'Distraction'},{id:'s_thigh',l:'Thigh Thrust'},{id:'s_comp',l:'Compression'},{id:'s_sacral',l:'Sacral Thrust'}], rules: [{c:3,t:"SIJ Dysfunction",x:"text-orange-500"}] },
            hip_oa: { name: "Altman's (Hip OA)", tests: [{id:'h_pain',l:'Hip Pain'},{id:'h_ir',l:'IR < 15'},{id:'h_flex',l:'Flex < 115'}], rules: [{c:3,t:"Hip OA",x:"text-orange-500"}] },
            shoulder_imp: { name: "Park's (Impingement)", tests: [{id:'s_hawk',l:'Hawkins'},{id:'s_pain_arc',l:'Pain Arc'},{id:'s_infra',l:'Infra Test'}], rules: [{c:2,t:"Impingement",x:"text-orange-500"}] },
            shoulder_cuff: { name: "Cuff Tear Cluster", tests: [{id:'s_can',l:'Empty Can'},{id:'s_drop',l:'Drop Arm'},{id:'s_lift',l:'Lift Off'}], rules: [{c:2,t:"Rotator Cuff Tear",x:"text-red-600"}] },
            shoulder_instab: { name: "Instability Cluster", tests: [{id:'s_app',l:'Apprehension'},{id:'s_reloc',l:'Relocation'}], rules: [{c:2,t:"Ant. Instability",x:"text-red-600"}] },
            elbow_lat: { name: "Lat. Epicondylitis", tests: [{id:'e_cozen',l:"Cozen's"},{id:'e_mill',l:"Mill's"},{id:'e_maud',l:"Maudsley's"}], rules: [{c:2,t:"Tennis Elbow",x:"text-orange-500"}] },
            wrist_cts: { name: "Carpal Tunnel", tests: [{id:'w_phalen',l:"Phalen's"},{id:'w_tinel',l:"Tinel's"},{id:'w_comp',l:"Carpal Comp"}], rules: [{c:2,t:"Probable CTS",x:"text-orange-500"}] },
            wrist_dequervain: { name: "De Quervain's", tests: [{id:'w_fink',l:"Finkelstein's"},{id:'w_eich',l:"Eichhoff's"},{id:'w_tend',l:"Radial Styloid Pain"}], rules: [{c:2,t:"De Quervain's",x:"text-orange-500"}] },
            knee_acl: { name: "ACL Cluster", tests: [{id:'k_lach',l:'Lachman'},{id:'k_ant',l:'Ant Drawer'},{id:'k_pivot',l:'Pivot Shift'}], rules: [{c:2,t:"ACL Injury",x:"text-red-600"}] },
            knee_meniscus: { name: "Meniscal Cluster", tests: [{id:'k_mcmur',l:'McMurray'},{id:'k_line',l:'Jnt Line Pain'},{id:'k_thess',l:'Thessaly'}], rules: [{c:2,t:"Meniscus Tear",x:"text-orange-500"}] },
            ankle_lat: { name: "Ankle Sprain", tests: [{id:'a_ant',l:'Ant Drawer'},{id:'a_talar',l:'Talar Tilt'},{id:'a_squeeze',l:'Squeeze'}], rules: [{c:2,t:"Lat. Sprain",x:"text-orange-500"}] }
        };

        const NEURO_LEVELS = { upper: ['C4', 'C5', 'C6', 'C7', 'C8', 'T1'], lower: ['L2', 'L3', 'L4', 'L5', 'S1', 'S2'] };
        const COMMON_NEURO = ['Wrist Drop (Radial N.)', 'Foot Drop (Peroneal N.)', 'Stroke (CVA)', "Bell's Palsy", 'Parkinsonism', 'Guillain-Barre'];

        const EXERCISE_DB = {
            "Cervical": ["Chin Tucks", "Deep Neck Flexor Hold"],
            "Lumbar": ["Cat-Camel", "Bird Dog", "Glute Bridges", "Dead Bugs", "Plank"],
            "Shoulder": ["Pendulums", "Wall Slides", "Sleeper Stretch", "YTWLs", "ER w/ Band"],
            "Neuro": ["Sit-to-Stand", "Weight Shifting", "PNF Patterns", "Mirror Therapy"],
            "Wrist": ["Wrist Extensor Stretch", "Tendon Glides", "Grip Strength", "Dart Thrower Motion"],
            "Ankle": ["Calf Raises", "Single Leg Balance", "Towel Scrunches"],
            "Balance": ["Tandem Stance", "Single Leg Stance", "Heel-Toe Walking"]
        };

        // --- COMPONENTS ---

        const TabButton = ({ active, label, icon, onClick, alert }) => (
            <button onClick={onClick} className={`flex items-center gap-2 px-4 py-3 rounded-xl text-left text-xs font-bold whitespace-nowrap transition-all ${active ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white/50 text-gray-500 hover:bg-white/80'}`}>
                <Icon name={icon} className={active ? 'text-blue-400' : 'text-gray-400'} /> {label} {alert && <span className="ml-auto w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
            </button>
        );

        const VisceroBox = ({ selected, onToggle }) => (
            <div className="bg-indigo-50 border border-indigo-100 p-4 rounded-xl mb-4">
                <h3 className="text-xs font-bold text-indigo-900 uppercase mb-3 flex items-center gap-2"><Icon name="lungs" /> Viscerosomatic Reflexes</h3>
                <div className="space-y-2">
                    {VISCERO_MAP.map(v => (
                        <div key={v.seg} className="flex items-center justify-between text-[10px]">
                            <button onClick={() => onToggle(v.seg)} className={`px-2 py-1 rounded font-bold border ${selected.includes(v.seg) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-500 border-gray-200'}`}>{v.seg}</button>
                            <span className="text-gray-600 font-medium">{v.organ}</span>
                        </div>
                    ))}
                </div>
            </div>
        );

        const ClusterBox = ({ cluster, values, onChange }) => {
            const pos = cluster.tests.filter(t => values[t.id]).length;
            const rule = [...cluster.rules].reverse().find(r => pos >= r.c);
            return (
                <div className={`bg-slate-50 border border-slate-100 rounded-xl p-3 mb-3 ${rule ? 'ring-2 ring-offset-1 ring-red-100' : ''}`}>
                    <div className="flex justify-between items-center mb-2">
                        <h4 className="font-bold text-xs text-gray-700"><Icon name="stethoscope" className="text-blue-500" /> {cluster.name}</h4>
                        <span className={`text-[10px] font-black px-1.5 py-0.5 rounded border ${pos>0?'bg-blue-100 text-blue-700':'bg-white text-gray-400'}`}>{pos}/{cluster.tests.length}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mb-2">
                        {cluster.tests.map(t => (
                            <label key={t.id} className={`flex items-center gap-2 p-1.5 rounded-lg cursor-pointer text-[10px] font-bold transition-all ${values[t.id]?'bg-blue-500 text-white':'bg-white text-gray-500 border'}`}>
                                <input type="checkbox" className="hidden" checked={!!values[t.id]} onChange={()=>onChange(t.id, !values[t.id])} /> {values[t.id] && <Icon name="check" />} {t.l}
                            </label>
                        ))}
                    </div>
                    {rule && <div className={`text-[10px] p-2 rounded bg-white border border-dashed border-gray-300 font-bold text-center animate-pulse-slow ${rule.x}`}>{rule.t}</div>}
                </div>
            );
        };

        const RomGrid = ({ d }) => (
            <div className="glass-panel p-4 rounded-xl mb-3">
                 <h4 className="text-xs font-bold text-gray-800 mb-3 border-b pb-2 uppercase tracking-wide">ROM Measurements</h4>
                 <div className="grid grid-cols-2 gap-x-4 gap-y-3">
                     {d.map(item => (
                         <div key={item.id} className="flex justify-between items-center">
                             <label className="text-[10px] font-bold text-gray-500 uppercase">{item.label}</label>
                             <div className="flex items-center">
                                 <input type="text" placeholder={item.norm} className="w-16 bg-white border border-gray-200 rounded px-2 py-1 text-xs font-bold text-right outline-none focus:border-blue-500" />
                                 <span className="text-[9px] text-gray-300 ml-1 font-bold">deg</span>
                             </div>
                         </div>
                     ))}
                 </div>
            </div>
        );

        const Vitals = ({ data, update }) => {
            const check = (t, v) => {
                if(!v) return '';
                if(t==='spo2' && parseInt(v)<95) return 'text-red-500 font-black animate-pulse';
                if(t==='bp') { const [s,d] = v.split('/').map(n=>parseInt(n)); if(s>140||d>90) return 'text-red-500 font-black animate-pulse'; }
                return 'text-gray-700';
            };
            return (
                <div className="glass-panel p-4 rounded-xl mb-4 flex gap-4 items-center overflow-x-auto">
                    <div className="flex flex-col"><span className="text-[10px] font-bold text-gray-400 uppercase">BP</span><input className={`w-16 bg-white rounded border p-1 text-xs font-bold text-center ${check('bp', data.vitals?.bp)}`} placeholder="120/80" value={data.vitals?.bp || ''} onChange={e=>update('vitals', 'bp', e.target.value)}/></div>
                    <div className="flex flex-col"><span className="text-[10px] font-bold text-gray-400 uppercase">HR</span><input className="w-12 bg-white rounded border p-1 text-xs font-bold text-center" placeholder="72" value={data.vitals?.hr || ''} onChange={e=>update('vitals', 'hr', e.target.value)}/></div>
                    <div className="flex flex-col"><span className="text-[10px] font-bold text-gray-400 uppercase">SpO2</span><input className={`w-12 bg-white rounded border p-1 text-xs font-bold text-center ${check('spo2', data.vitals?.spo2)}`} placeholder="98%" value={data.vitals?.spo2 || ''} onChange={e=>update('vitals', 'spo2', e.target.value)}/></div>
                    <div className="flex flex-col"><span className="text-[10px] font-bold text-gray-400 uppercase">RR</span><input className="w-12 bg-white rounded border p-1 text-xs font-bold text-center" placeholder="16" value={data.vitals?.rr || ''} onChange={e=>update('vitals', 'rr', e.target.value)}/></div>
                </div>
            );
        };

        const ExerciseRow = ({ ex, index, onUpdate, onDelete }) => (
            <div className="flex items-center gap-2 mb-2 bg-white p-2 rounded-lg border border-gray-200 shadow-sm animate-fade-in">
                <div className="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">{index + 1}</div>
                <div className="flex-1">
                    <input className="w-full text-xs font-bold text-gray-800 bg-transparent outline-none" value={ex.name} onChange={e => onUpdate(index, 'name', e.target.value)} placeholder="Exercise Name" />
                    <div className="flex gap-2 mt-1">
                        <input className="w-12 text-[10px] bg-gray-50 rounded px-1" placeholder="Sets" value={ex.sets} onChange={e => onUpdate(index, 'sets', e.target.value)} />
                        <span className="text-[10px] text-gray-400">x</span>
                        <input className="w-12 text-[10px] bg-gray-50 rounded px-1" placeholder="Reps" value={ex.reps} onChange={e => onUpdate(index, 'reps', e.target.value)} />
                        <input className="w-16 text-[10px] bg-gray-50 rounded px-1" placeholder="Freq" value={ex.freq} onChange={e => onUpdate(index, 'freq', e.target.value)} />
                    </div>
                </div>
                <button onClick={() => onDelete(index)} className="text-gray-400 hover:text-red-500"><Icon name="trash" size="text-xs" /></button>
            </div>
        );

        const NeuroRow = ({ level, data, onChange }) => (
            <div className="grid grid-cols-7 gap-1 items-center mb-1 text-center text-xs">
                <div className="font-bold text-gray-500 col-span-1 bg-gray-100 rounded py-1">{level}</div>
                {['d_r','d_l','m_r','m_l','r_r','r_l'].map((type) => {
                    const key = `${level}_${type}`;
                    const val = data[key] || '';
                    const isReflex = type.startsWith('r');
                    const isAbnormal = val && val !== (isReflex ? '2+' : '5') && val !== 'N';
                    return (
                        <input
                            key={key} type="text" value={val} onChange={(e) => onChange(key, e.target.value)} placeholder={isReflex ? '2+' : '5'}
                            className={`col-span-1 border rounded py-1 text-center outline-none focus:border-blue-500 font-bold ${isAbnormal ? 'bg-red-100 text-red-600' : 'bg-white text-gray-700'}`}
                        />
                    )
                })}
            </div>
        );

        const ReportModal = ({ data, insights, onClose }) => {
            const printRef = useRef();
            const handlePrint = () => {
                const element = printRef.current;
                const opt = { margin: 10, filename: `Assessment_${data.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                html2pdf().set(opt).from(element).save();
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden animate-slide-up">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="text-lg font-bold text-gray-800">Assessment Report</h2>
                            <div className="flex gap-2">
                                <button onClick={handlePrint} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-700"><Icon name="print" /> PDF</button>
                                <button onClick={onClose} className="bg-gray-200 text-gray-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-gray-300">Close</button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-8 bg-gray-100">
                            <div ref={printRef} className="bg-white p-8 shadow-sm mx-auto max-w-2xl min-h-[1000px]">
                                <div className="border-b-2 border-blue-600 pb-4 mb-6 flex justify-between">
                                    <div><h1 className="text-2xl font-bold text-blue-900">PhysioPro Report</h1><p className="text-gray-500 text-sm">Clinical Assessment</p></div>
                                    <div className="text-right"><p className="font-bold">{data.date}</p><p className="text-sm text-gray-500">ID: {data.id}</p></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                                    <div><span className="text-xs font-bold text-gray-400 uppercase">Patient</span><p className="font-bold text-gray-800">{data.name}</p></div>
                                    <div><span className="text-xs font-bold text-gray-400 uppercase">Diagnosis</span><p className="font-bold text-gray-800">{data.dx}</p></div>
                                    {data.age && <div><span className="text-xs font-bold text-gray-400 uppercase">Age</span><p className="font-bold text-gray-800">{data.age}</p></div>}
                                    {data.sex && <div><span className="text-xs font-bold text-gray-400 uppercase">Sex</span><p className="font-bold text-gray-800">{data.sex}</p></div>}
                                    <div className="col-span-2"><span className="text-xs font-bold text-gray-400 uppercase">History</span><p className="text-sm text-gray-800">{data.cc}</p></div>
                                </div>

                                {data.vitals && (
                                    <div className="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200 flex gap-6 text-sm">
                                        {data.vitals.bp && <span><strong>BP:</strong> {data.vitals.bp}</span>}
                                        {data.vitals.hr && <span><strong>HR:</strong> {data.vitals.hr}</span>}
                                        {data.vitals.spo2 && <span><strong>SpO2:</strong> {data.vitals.spo2}</span>}
                                        {data.vitals.rr && <span><strong>RR:</strong> {data.vitals.rr}</span>}
                                    </div>
                                )}

                                {data.commonNeuro.length > 0 && (
                                    <div className="mb-6 bg-purple-50 p-4 rounded-lg border border-purple-200">
                                        <h3 className="font-bold text-purple-800 text-xs uppercase mb-2">Identified Conditions</h3>
                                        <div className="flex flex-wrap gap-2">{data.commonNeuro.map(c => <span key={c} className="bg-white px-2 py-1 rounded text-xs font-bold border">{c}</span>)}</div>
                                    </div>
                                )}

                                {(data.cognitive?.mmse || data.cognitive?.moca) && (
                                    <div className="mb-6 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                        <h3 className="font-bold text-yellow-800 text-xs uppercase mb-2">Cognitive Screen</h3>
                                        <div className="flex gap-4 text-sm">
                                            {data.cognitive.mmse && <span><strong>MMSE:</strong> {data.cognitive.mmse}/30</span>}
                                            {data.cognitive.moca && <span><strong>MoCA:</strong> {data.cognitive.moca}/30</span>}
                                        </div>
                                    </div>
                                )}

                                {data.psfs && data.psfs.length > 0 && (
                                    <div className="mb-6 bg-green-50 p-4 rounded-lg border border-green-200">
                                        <h3 className="font-bold text-green-800 text-xs uppercase mb-2">PSFS - Functional Scale</h3>
                                        <ul className="text-sm text-gray-700 list-disc pl-4">
                                            {data.psfs.map((item, idx) => (
                                                <li key={idx}><strong>{item.activity}:</strong> {item.score}/10</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {insights.length > 0 && (
                                    <div className="mb-6 border border-blue-100 rounded-lg overflow-hidden">
                                        <div className="bg-blue-50 p-2 border-b border-blue-100 font-bold text-blue-800 text-sm">Automated Insights</div>
                                        <div className="p-3 space-y-2">
                                            {insights.map((ins, i) => (
                                                <div key={i} className="flex gap-2 text-xs"><span className={`font-bold ${ins.type === 'red' ? 'text-red-600' : 'text-blue-600'}`}>• {ins.text}</span></div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="mb-6">
                                    <h3 className="font-bold text-gray-800 border-b mb-2 pb-1">Treatment Plan</h3>
                                    <p className="text-sm text-gray-700 whitespace-pre-wrap">{data.treatmentNotes}</p>
                                </div>
                                {data.exercises.length > 0 && (
                                    <div className="mb-6">
                                        <h3 className="font-bold text-gray-800 border-b mb-2 pb-1">Home Exercise Program</h3>
                                        <table className="w-full text-xs text-left">
                                            <thead className="text-gray-500 uppercase bg-gray-50"><tr><th className="p-2">Exercise</th><th className="p-2">Dosage</th><th className="p-2">Freq</th></tr></thead>
                                            <tbody>
                                                {data.exercises.map((ex, i) => (
                                                    <tr key={i} className="border-b last:border-0"><td className="p-2 font-bold">{ex.name}</td><td className="p-2">{ex.sets} x {ex.reps}</td><td className="p-2">{ex.freq}</td></tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LetterModal = ({ data, insights, onClose }) => {
            const [text, setText] = useState('');
            useEffect(() => {
                const today = new Date().toLocaleDateString();
                const findings = insights.map(i => i.text).join(', ');
                const ltr = `Date: ${today}\n\nRe: Referral for ${data.name} (ID: ${data.id})\n\nDear Doctor,\n\nThank you for referring ${data.name} for physiotherapy. I have assessed the patient today regarding their ${data.cc}.\n\nObjective Findings:\n- Pain Scale: ${data.vas}/10\n- Key Findings: ${findings || 'N/A'}\n${data.vitals?.bp ? `- BP: ${data.vitals.bp}, HR: ${data.vitals.hr}` : ''}\n\nClinical Impression:\n${data.dx || 'Musculoskeletal Dysfunction'}\n\nTreatment Plan:\n${data.treatment.join(', ') || 'Manual therapy and exercise rehabilitation'}.\n\nWe will continue to monitor their progress.\n\nSincerely,\n\n[Your Name]\nPhysiotherapist`;
                setText(ltr);
            }, [data, insights]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden animate-slide-up">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="text-lg font-bold text-gray-800">Referral Letter Writer</h2>
                            <button onClick={onClose}><Icon name="xmark" /></button>
                        </div>
                        <div className="p-4">
                            <textarea className="w-full h-96 p-4 border rounded-xl text-sm font-mono bg-gray-50 outline-none resize-none" value={text} onChange={e=>setText(e.target.value)}></textarea>
                            <div className="mt-4 flex justify-end gap-2">
                                <button onClick={() => navigator.clipboard.writeText(text).then(()=>alert('Copied!'))} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-700"><Icon name="copy" /> Copy to Clipboard</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PatientManager = ({ current, onLoad, onNew, onClose }) => {
            const [saved, setSaved] = useState([]);
            useEffect(() => { const s = localStorage.getItem('physioProSessions'); if(s) setSaved(JSON.parse(s)); }, []);
            const saveCurrent = () => {
                if(!current.name) return alert("Enter patient name first");
                const newSession = { ...current, savedAt: new Date().toLocaleString() };
                const newSaved = [newSession, ...saved.filter(s => s.id !== current.id)];
                localStorage.setItem('physioProSessions', JSON.stringify(newSaved)); setSaved(newSaved); alert("Saved!");
            };
            const deleteSession = (id) => { if(confirm("Delete?")) { const n = saved.filter(s => s.id !== id); localStorage.setItem('physioProSessions', JSON.stringify(n)); setSaved(n); }};
            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(saved));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "physio_pro_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };
            const importData = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    const parsed = JSON.parse(e.target.result);
                    localStorage.setItem('physioProSessions', JSON.stringify(parsed));
                    setSaved(parsed);
                    alert("Data Imported!");
                };
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50"><h2 className="text-lg font-bold text-gray-800">Patient Manager</h2><button onClick={onClose}><Icon name="xmark" /></button></div>
                        <div className="p-4">
                            <div className="flex gap-2 mb-4"><button onClick={saveCurrent} className="flex-1 bg-blue-600 text-white py-2 rounded-xl text-sm font-bold">Save Current</button><button onClick={onNew} className="flex-1 bg-green-600 text-white py-2 rounded-xl text-sm font-bold">New Patient</button></div>
                            <div className="flex gap-2 mb-4 pt-4 border-t border-gray-100">
                                <button onClick={exportData} className="flex-1 bg-gray-100 text-gray-600 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-200"><Icon name="download" /> Export JSON</button>
                                <label className="flex-1 bg-gray-100 text-gray-600 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-200 text-center cursor-pointer"><Icon name="upload" /> Import JSON <input type="file" className="hidden" onChange={importData} /></label>
                            </div>
                            <div className="space-y-2 max-h-60 overflow-y-auto">{saved.map(s => (<div key={s.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-blue-50" onClick={() => {onLoad(s); onClose();}}><div><p className="font-bold text-sm">{s.name}</p><p className="text-[10px] text-gray-500">{s.dx}</p></div><button onClick={(e) => {e.stopPropagation(); deleteSession(s.id);}} className="text-gray-300 hover:text-red-500"><Icon name="trash" /></button></div>))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const FallRiskCalc = ({ data, update }) => {
            const [test, setTest] = useState('tug');
            const [val, setVal] = useState('');

            const checkRisk = (t, v) => {
                if(!v) return '';
                if(t === 'tug') return v > 13.5 ? 'High Risk' : 'Low Risk';
                if(t === 'sts') return v < 12 ? 'High Risk' : 'Normal';
                return '';
            }

            return (
                <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl flex flex-col items-center">
                    <h3 className="text-xs font-bold text-orange-800 uppercase mb-3 flex items-center gap-2"><Icon name="person-cane" /> Geriatric Fall Risk</h3>
                    <div className="flex gap-2 mb-3 bg-white rounded-lg p-1 border">
                        <button onClick={()=>setTest('tug')} className={`px-3 py-1 rounded text-xs font-bold ${test==='tug'?'bg-orange-500 text-white':'text-gray-500'}`}>TUG</button>
                        <button onClick={()=>setTest('sts')} className={`px-3 py-1 rounded text-xs font-bold ${test==='sts'?'bg-orange-500 text-white':'text-gray-500'}`}>30s STS</button>
                    </div>
                    <div className="flex items-center gap-2">
                        <input type="number" placeholder={test==='tug'?'Seconds':'Reps'} className="w-20 p-2 rounded border text-center font-bold" value={val} onChange={e => {setVal(e.target.value); update('fallRisk', {test, val:e.target.value, risk: checkRisk(test, e.target.value)})}} />
                        <span className="text-sm font-bold text-orange-700">{val ? checkRisk(test, val) : '-'}</span>
                    </div>
                </div>
            );
        };

        const PsfsModule = ({ data, update }) => {
            const addActivity = () => update('psfs', [...(data.psfs || []), {activity: '', score: ''}]);
            const updateItem = (idx, f, v) => {
                const n = [...(data.psfs || [])];
                n[idx][f] = v;
                update('psfs', n);
            };
            const avg = (data.psfs || []).reduce((a,b)=>a+(parseInt(b.score)||0),0) / ((data.psfs||[]).length || 1);

            return (
                <div className="glass-panel p-5 rounded-3xl mb-4">
                    <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-gray-800 uppercase text-xs">PSFS (Functional Scale)</h3>
                        <span className="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">Avg: {avg.toFixed(1)}</span>
                    </div>
                    <div className="space-y-2">
                        {(data.psfs || []).map((item, i) => (
                            <div key={i} className="flex gap-2">
                                <input className="flex-1 bg-white border border-gray-200 rounded p-2 text-xs" placeholder="Activity (e.g., Putting on socks)" value={item.activity} onChange={e=>updateItem(i,'activity',e.target.value)} />
                                <input type="number" max="10" className="w-16 bg-white border border-gray-200 rounded p-2 text-xs text-center font-bold" placeholder="0-10" value={item.score} onChange={e=>updateItem(i,'score',e.target.value)} />
                            </div>
                        ))}
                        <button onClick={addActivity} className="text-xs text-blue-600 font-bold hover:underline">+ Add Activity</button>
                    </div>
                </div>
            );
        };

        const DictationButton = ({ onResult }) => {
            const [listening, setListening] = useState(false);
            const start = () => {
                if(!('webkitSpeechRecognition' in window)) return alert("Browser not supported");
                const r = new window.webkitSpeechRecognition();
                r.continuous = false; r.interimResults = false;
                r.onstart = () => setListening(true);
                r.onend = () => setListening(false);
                r.onresult = (e) => onResult(e.results[0][0].transcript);
                r.start();
            };
            return <button onClick={start} className={`p-2 rounded-full transition-all ${listening ? 'bg-red-500 text-white animate-pulse' : 'text-gray-400 hover:text-blue-500'}`}><Icon name="microphone" /></button>
        };

        const SmileyVAS = ({ value, onChange, label="Current Pain" }) => {
            const numVal = parseInt(value) || 0;
            const getColor = (v) => v <= 3 ? '#34C759' : v <= 7 ? '#FFCC00' : '#FF3B30';
            const getMouth = (v) => { const f = v/10; const yC = 85-(30*f); const yS = 65+(10*f); return `M 30 ${yS} Q 50 ${yC} 70 ${yS}`; };
            return (
                <div className="bg-white/60 p-6 rounded-3xl border border-white/50 shadow-sm flex flex-col items-center w-full max-w-sm mx-auto">
                    <label className="text-[10px] font-bold text-gray-400 uppercase mb-2">{label}</label>
                    <div className="relative w-24 h-24 mb-4 transition-transform duration-300 transform hover:scale-105">
                        <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-xl"><circle cx="50" cy="50" r="45" fill={getColor(numVal)} className="transition-colors duration-500" /><circle cx="35" cy="40" r="5" fill="white" /><circle cx="65" cy="40" r="5" fill="white" /><path d={getMouth(numVal)} fill="none" stroke="white" strokeWidth="5" strokeLinecap="round" className="transition-all duration-500" /></svg>
                        <div className="absolute inset-0 flex items-center justify-center text-white font-black text-2xl drop-shadow-md opacity-90">{numVal}</div>
                    </div>
                    <div className="w-full px-2">
                        <div className="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-1"><span>0</span><span>10</span></div>
                        <input type="range" min="0" max="10" value={numVal} onChange={e => onChange(e.target.value)} className="w-full h-8 rounded-full appearance-none cursor-pointer vas-slider" />
                    </div>
                </div>
            );
        };

        const Stopwatch = () => {
            const [time, setTime] = useState(0);
            const [running, setRunning] = useState(false);
            useEffect(() => { let int; if(running) int = setInterval(() => setTime(t => t+10), 10); else clearInterval(int); return () => clearInterval(int); }, [running]);
            const fmt = (ms) => { const s = Math.floor(ms / 1000); const m = Math.floor(s / 60); return `${m}:${(s%60).toString().padStart(2,'0')}.${(Math.floor(ms%1000/10)).toString().padStart(2,'0')}`; };
            return <div className="flex items-center gap-2 bg-gray-900 text-white px-3 py-1 rounded-lg"><span className="font-mono text-sm font-bold w-16 text-center">{fmt(time)}</span><button onClick={() => setRunning(!running)} className="text-xs hover:text-green-400"><Icon name={running ? 'pause' : 'play'} /></button><button onClick={() => {setRunning(false); setTime(0)}} className="text-xs hover:text-red-400"><Icon name="rotate-left" /></button></div>;
        };

        const BodyMap = ({id, path}) => {
            const canvasRef = useRef(null);
            const [drawing, setDrawing] = useState(false);
            const [penColor, setPenColor] = useState('#ef4444');
            useEffect(() => { const c = canvasRef.current; c.width=260; c.height=520; c.getContext('2d').lineCap='round'; }, []);
            const draw = (e) => {
                if(!drawing) return;
                const ctx = canvasRef.current.getContext('2d');
                ctx.strokeStyle = penColor; ctx.lineWidth = 4;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = ((e.clientX||e.touches[0].clientX) - rect.left);
                const y = ((e.clientY||e.touches[0].clientY) - rect.top);
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            };
            return (
                <div className="flex flex-col gap-2">
                    <div className="flex gap-2 justify-center mb-2">{[{c:'#ef4444',n:'Pain'},{c:'#3b82f6',n:'Stiff'}].map(x=><button key={x.c} onClick={()=>setPenColor(x.c)} className={`w-6 h-6 rounded-full border-2 ${penColor===x.c?'border-black':'border-transparent'}`} style={{background:x.c}}/>)}</div>
                    <div className="relative"><svg viewBox="0 0 250 500" className="absolute inset-0 opacity-50"><path d={path} fill="#f1f5f9" stroke="#94a3b8" strokeWidth="2"/></svg><canvas ref={canvasRef} className="relative z-10 w-[260px] h-[520px] cursor-crosshair touch-none" onMouseDown={()=>{setDrawing(true);const ctx=canvasRef.current.getContext('2d');ctx.beginPath();}} onMouseUp={()=>{setDrawing(false);const ctx=canvasRef.current.getContext('2d');ctx.beginPath();}} onMouseMove={draw} onTouchStart={()=>{setDrawing(true);const ctx=canvasRef.current.getContext('2d');ctx.beginPath();}} onTouchMove={draw} onTouchEnd={()=>setDrawing(false)}/></div>
                </div>
            )
        };

        const AssessmentApp = () => {
            const [mainTab, setMainTab] = useState('Intake');
            const [subTab, setSubTab] = useState(1);
            const [neuroTab, setNeuroTab] = useState('Screening');
            const [penColor, setPenColor] = useState('#ef4444');
            const [showReport, setShowReport] = useState(false);
            const [showLetter, setShowLetter] = useState(false);
            const [showManager, setShowManager] = useState(false);
            const [newExercise, setNewExercise] = useState('');
            const [syncStatus, setSyncStatus] = useState('');

            const [data, setData] = useState({
                id: Date.now(), name: '', age: '', sex: '', date: new Date().toISOString().split('T')[0], onset: '',
                dx: '', cc: '', vas: '0',
                redFlags: [], viscerosomatic: [], commonNeuro: [], rom: {}, neuro: {}, tests: {}, landmarks: {}, painQ: {},
                posture: {}, gait: {},
                vitals: { bp: '', hr: '', spo2: '', rr: '' },
                cognitive: { mmse: '', moca: '' },
                cranial: { cn7_r: false, cn7_l: false, grade: '' },
                stroke: { brun_arm: '', brun_hand: '', brun_leg: '', ashworth: '' },
                scales: { ndi: '', odi: '', dash: '', lefs: '' },
                psfs: [], fallRisk: {},
                osteopath: { texture: false, asym: false, rom: false, tender: false, notes: '' },
                treatment: [], treatmentNotes: '', postVas: '0', postStatus: 'Same', postNotes: '', exercises: []
            });

            useEffect(() => {
                const s = localStorage.getItem('physioProCurrent');
                let startData = data;
                if(s) try{ startData = {...startData, ...JSON.parse(s)}; }catch(e){}
                
                // URL Params Override
                const params = new URLSearchParams(window.location.search);
                const pName = params.get('name');
                const pId = params.get('id');
                const pAge = params.get('age');
                const pSex = params.get('sex');
                
                if(pName || pId) {
                    startData = {
                        ...startData,
                        name: pName || startData.name,
                        id: pId || startData.id,
                        age: pAge || startData.age,
                        sex: pSex || startData.sex
                    };
                }
                setData(startData);
            }, []);

            useEffect(() => { localStorage.setItem('physioProCurrent', JSON.stringify(data)); }, [data]);

            const update = (cat, k, v) => setData(p => ({...p, [cat]: {...p[cat], [k]: v}}));
            const toggleArr = (cat, val) => setData(p => ({...p, [cat]: p[cat].includes(val) ? p[cat].filter(x=>x!==val) : [...p[cat], val]}));
            const clearData = () => { if(confirm("Start new patient?")) { setData({ id: Date.now(), name: '', age: '', sex: '', date: new Date().toISOString().split('T')[0], onset: '', dx: '', cc: '', vas: '0', redFlags: [], viscerosomatic: [], commonNeuro: [], rom: {}, neuro: {}, tests: {}, landmarks: {}, painQ: {}, posture: {}, gait: {}, cognitive: { mmse: '', moca: '' }, cranial: { cn7_r: false, cn7_l: false, grade: '' }, stroke: { brun_arm: '', brun_hand: '', brun_leg: '', ashworth: '' }, scales: { ndi: '', odi: '', dash: '', lefs: '' }, psfs: [], fallRisk: {}, osteopath: { texture: false, asym: false, rom: false, tender: false, notes: '' }, treatment: [], treatmentNotes: '', postVas: '0', postStatus: 'Same', postNotes: '', exercises: [] }); setShowManager(false); }};

            const addExercise = (name) => { if(!name) return; setData(p => ({...p, exercises: [...p.exercises, { name, sets: '3', reps: '10', freq: 'Daily' }]})); setNewExercise(''); };
            const updateExercise = (idx, field, val) => { const updated = [...data.exercises]; updated[idx][field] = val; setData({...data, exercises: updated}); };
            const removeExercise = (idx) => { setData(p => ({...p, exercises: p.exercises.filter((_, i) => i !== idx)})); };

            const saveToCloud = async () => {
                if(!GOOGLE_SCRIPT_URL.startsWith("http")) { alert("Please set the GOOGLE_SCRIPT_URL variable in the code (or Settings)."); return; }
                setSyncStatus('Saving...');
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    setSyncStatus('Saved!');
                    setTimeout(() => setSyncStatus(''), 3000);
                } catch(e) {
                    console.error(e);
                    setSyncStatus('Error');
                }
            };

            // --- SMART BRAIN ---
            const brain = useMemo(() => {
                const insights = [];
                const ex = [];
                const t = data.tests || {};
                const n = data.neuro || {};
                const cn = data.commonNeuro || [];
                const p = data.posture || {};
                const g = data.gait || {};
                const fr = data.fallRisk || {};
                const v = data.vitals || {};

                // Ortho Logic
                if(CLUSTERS.cervical.tests.filter(x=>t[x.id]).length >= 3) { insights.push({type:'red', text:"Cervical Radiculopathy"}); ex.push("Chin Tucks", "Median Nerve Glides"); }
                if(CLUSTERS.cervical_myelopathy.tests.filter(x=>t[x.id]).length >= 3) { insights.push({type:'red', text:"POSSIBLE CERVICAL MYELOPATHY (Urgent Referral)"}); }
                if(CLUSTERS.lumbar_stenosis.tests.filter(x=>t[x.id]).length >= 4) { insights.push({type:'red', text:"Lumbar Stenosis"}); ex.push("Post. Pelvic Tilts", "Single Knee to Chest"); }
                if(CLUSTERS.lumbar_instability.tests.filter(x=>t[x.id]).length >= 3) { insights.push({type:'orange', text:"Lumbar Instability"}); ex.push("Core Stabilization", "Dead Bugs"); }
                if(CLUSTERS.elbow_lat.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'orange', text:"Lat. Epicondylitis"}); ex.push("Eccentric Wrist Ext"); }
                if(CLUSTERS.wrist_cts.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'orange', text:"Carpal Tunnel Syndrome"}); ex.push("Tendon Glides", "Median Nerve Glides"); }
                if(CLUSTERS.wrist_dequervain.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'orange', text:"De Quervain's"}); ex.push("Thumb Spica", "Gentle ROM"); }
                if(CLUSTERS.knee_meniscus.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'orange', text:"Meniscal Tear"}); ex.push("Quad Sets", "ROM Exercises"); }
                if(CLUSTERS.ankle_lat.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'orange', text:"Lat Ankle Sprain"}); ex.push("Proprioception", "Calf Raises"); }
                if(CLUSTERS.shoulder_cuff.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'red', text:"Rotator Cuff Pathology"}); ex.push("Cuff Strengthening", "Scapular Control"); }
                if(CLUSTERS.shoulder_instab.tests.filter(x=>t[x.id]).length >= 2) { insights.push({type:'red', text:"Shoulder Instability"}); ex.push("Rhythmic Stabilization"); }

                // Neuro / Common Conditions
                if(cn.includes('Wrist Drop (Radial N.)')) { insights.push({type:'red', text:"Radial Nerve Palsy"}); ex.push("Cock-up Splint", "Passive Wrist Ext"); }
                if(cn.includes('Foot Drop (Peroneal N.)')) { insights.push({type:'red', text:"Peroneal Nerve Palsy"}); ex.push("AFO Evaluation", "Dorsiflex Assist"); }
                if(cn.includes("Bell's Palsy")) { insights.push({type:'orange', text:"Facial Nerve Palsy"}); ex.push("Active Assisted Eye Closure", "Mirror Feedback"); }

                // Posture & Gait & Fall Risk
                if(p['Head'] === 'Forward Head') { insights.push({type:'blue', text:"Forward Head Posture"}); ex.push("Chin Tucks"); }
                if(g['Gait'] === 'Trendelenburg') { insights.push({type:'blue', text:"Trendelenburg Gait"}); ex.push("Glute Med Strengthening"); }
                if(fr.risk === 'High Risk') { insights.push({type:'red', text:"High Fall Risk Detected"}); ex.push("Tandem Stance", "Sit to Stand"); }

                // Vitals
                if(v.bp && parseInt(v.bp.split('/')[0]) > 140) insights.push({type:'red', text:"Hypertension Alert"});
                if(v.spo2 && parseInt(v.spo2) < 95) insights.push({type:'red', text:"Hypoxia Alert"});

                // Header alert triggers
                const hasRedFlag = data.redFlags.length > 0;
                const hasMyelopathy = CLUSTERS.cervical_myelopathy.tests.filter(x=>t[x.id]).length >= 3;

                return { insights, ex: [...new Set(ex)], hasRedFlag, hasMyelopathy };
            }, [data]);

            const autoFillExercises = () => {
                const newExs = brain.ex.map(e => ({ name: e, sets: '3', reps: '10', freq: 'Daily' }));
                setData(p => ({...p, exercises: [...p.exercises, ...newExs]}));
            };

            const TABS = ['Intake', 'Objective', 'Spine & Core', 'Neurological', 'Extremities', 'Assessment', 'Post Assessment'];
            const pFront = "M100,35 C115,35 125,25 125,15 C125,5 115,-5 100,-5 C85,-5 75,5 75,15 C75,25 85,35 100,35 Z M100,45 L100,65 M85,65 L115,65 M115,65 L160,75 L150,150 L165,230 L155,250 M85,65 L40,75 L50,150 L35,230 L45,250 M85,65 L115,65 L125,160 L130,220 L70,220 L75,160 Z M70,220 L130,220 M75,220 L60,350 L80,450 L100,450 M125,220 L140,350 L120,450 L100,450";
            const pBack = "M100,35 C115,35 125,25 125,15 C125,5 115,-5 100,-5 C85,-5 75,5 75,15 C75,25 85,35 100,35 Z M100,45 L100,65 M85,65 L115,65 M115,65 L160,75 L150,150 L165,230 L155,250 M85,65 L40,75 L50,150 L35,230 L45,250 M85,65 L115,65 L125,140 L130,220 L70,220 L75,140 Z M100,65 L100,220 M70,220 L130,220 M75,220 L60,350 L80,450 L100,450 M125,220 L140,350 L120,450 L100,450";

            return (
                <div className="h-[100dvh] flex flex-col bg-slate-50 font-sans overflow-hidden">
                    {/* HEADER */}
                    <div className={`backdrop-blur border-b p-3 flex justify-between items-center z-50 transition-colors duration-500 ${brain.hasRedFlag || brain.hasMyelopathy ? 'bg-red-50 border-red-200' : 'bg-white/80'}`}>
                        <div className="flex items-center gap-3">
                            <a href="index.html" className="bg-gray-100 text-gray-600 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-200 transition-colors" title="Back to Home"><Icon name="house" /></a>
                            <div className={`${brain.hasRedFlag ? 'bg-red-600 animate-pulse' : 'bg-blue-600'} text-white w-10 h-10 rounded-xl flex items-center justify-center shadow`}><Icon name={brain.hasRedFlag ? "triangle-exclamation" : "user-doctor"}/></div>
                            <div>
                                <h1 className="font-bold text-gray-900 leading-tight">PhysioPro v24</h1>
                                <p className={`text-[10px] font-bold uppercase tracking-wide ${brain.hasRedFlag ? 'text-red-600' : 'text-gray-500'}`}>
                                    {brain.hasRedFlag ? 'RED FLAG ALERT' : 'Diagnostic Powerhouse'}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                             <span className="text-[10px] font-bold text-green-600 uppercase animate-pulse">{syncStatus}</span>
                             <button onClick={saveToCloud} className="bg-blue-50 text-blue-600 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-100" title="Save to Cloud"><Icon name="cloud-arrow-up" /></button>
                             <button onClick={()=>setShowManager(true)} className="bg-gray-100 text-gray-600 px-3 py-2 rounded-xl text-xs font-bold hover:bg-gray-200"><Icon name="users" /> Patients</button>
                             <button onClick={() => setShowReport(true)} className="bg-gray-900 text-white px-3 py-2 rounded-xl text-xs font-bold shadow-lg hover:bg-gray-800"><Icon name="file-medical" /> Report</button>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 overflow-y-auto p-4 pb-20 custom-scrollbar">
                        <div className="max-w-4xl mx-auto">
                            {/* TAB BAR */}
                            <div className="flex overflow-x-auto gap-2 mb-6 p-1 bg-white rounded-xl shadow-sm border sticky top-0 z-40">
                                {TABS.map(t => <button key={t} onClick={()=>setMainTab(t)} className={`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${mainTab===t?'bg-blue-600 text-white shadow':'text-gray-500 hover:bg-gray-50'}`}>{t}</button>)}
                            </div>

                            {/* INTAKE */}
                            {mainTab === 'Intake' && <div className="animate-fade-in space-y-4">
                                <div className="glass-panel p-5 rounded-3xl grid grid-cols-2 gap-4">
                                    <div className="col-span-2"><span className="text-[10px] font-bold text-gray-400 uppercase">Patient Name</span><input className="w-full text-lg font-bold bg-transparent outline-none border-b border-gray-200 focus:border-blue-500" value={data.name} onChange={e=>setData({...data, name:e.target.value})} placeholder="Enter Name"/></div>
                                    <div><span className="text-[10px] font-bold text-gray-400 uppercase">ID</span><input className="w-full font-medium bg-transparent outline-none border-b border-gray-200" value={data.id} onChange={e=>setData({...data, id:e.target.value})}/></div>
                                    <div><span className="text-[10px] font-bold text-gray-400 uppercase">Age</span><input className="w-full font-medium bg-transparent outline-none border-b border-gray-200" value={data.age} onChange={e=>setData({...data, age:e.target.value})}/></div>
                                    <div className="col-span-2"><span className="text-[10px] font-bold text-gray-400 uppercase">Sex</span><select className="w-full font-medium bg-transparent outline-none border-b border-gray-200" value={data.sex} onChange={e=>setData({...data, sex:e.target.value})}><option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                                    <div className="col-span-2 relative"><span className="text-[10px] font-bold text-gray-400 uppercase">Chief Complaint</span><div className="absolute right-0 top-0"><DictationButton onResult={t => setData({...data, cc: (data.cc ? data.cc + ' ' : '') + t})} /></div><textarea className="w-full bg-gray-50 rounded-xl p-3 mt-1 text-sm outline-none" rows="3" value={data.cc} onChange={e=>setData({...data, cc:e.target.value})}/></div>
                                </div>
                                <div className="flex justify-center animate-fade-in mt-6">
                                    <SmileyVAS value={data.vas} onChange={v => setData({...data, vas:v})} label="Current Pain (VAS)" />
                                </div>
                            </div>}

                            {/* OBJECTIVE */}
                            {mainTab === 'Objective' && <div className="animate-fade-in space-y-6">
                                <Vitals data={data} update={update} />
                                <div className="glass-panel p-5 rounded-3xl">
                                    <h3 className="font-bold text-gray-800 uppercase text-xs mb-3">Posture Scan</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {Object.keys(POSTURE_OPTS).map(region => (
                                            <div key={region} className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                <h4 className="text-[10px] font-bold text-gray-400 uppercase mb-2">{region}</h4>
                                                <div className="space-y-1">
                                                    {POSTURE_OPTS[region].map(opt => (
                                                        <label key={opt} className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer">
                                                            <input type="checkbox" className="accent-blue-600" checked={data.posture[region] === opt} onChange={() => update('posture', region, opt)} />
                                                            {opt}
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex flex-col md:flex-row gap-4">
                                    <div className="glass-panel p-5 rounded-3xl flex-1">
                                        <h3 className="font-bold text-gray-800 uppercase text-xs mb-3">Gait Analysis</h3>
                                        <div className="space-y-2">
                                            {GAIT_OPTS.map(g => (
                                                <label key={g} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-gray-100 cursor-pointer hover:bg-blue-50 transition-colors">
                                                    <input type="checkbox" className="accent-blue-600" checked={data.gait['Gait'] === g} onChange={() => update('gait', 'Gait', g)} />
                                                    <span className="text-xs font-bold text-gray-600">{g}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="glass-panel p-5 rounded-3xl flex-1 flex flex-col items-center justify-center bg-gray-900 text-white">
                                        <div className="text-center mb-4">
                                            <Icon name="stopwatch" size="text-2xl text-blue-400" />
                                            <h3 className="font-bold uppercase text-xs mt-1">Functional Timer</h3>
                                            <p className="text-[10px] text-gray-400">For SLS, TUG, Wall Sit</p>
                                        </div>
                                        <Stopwatch />
                                    </div>
                                </div>
                                <FallRiskCalc data={data} update={setData} />
                            </div>}

                            {/* SPINE & CORE */}
                            {mainTab === 'Spine & Core' && <div className="flex flex-col md:flex-row gap-4 animate-fade-in">
                                <div className="md:w-48 flex-shrink-0 flex md:flex-col gap-2 overflow-x-auto pb-2">
                                    {[{id:1,l:'Screening'},{id:3,l:'Cervical'},{id:4,l:'Thoracic'},{id:5,l:'Lumbar'},{id:6,l:'SIJ / Sacrum'},{id:7,l:'Hip'}].map(x=><button key={x.id} onClick={()=>setSubTab(x.id)} className={`px-4 py-3 rounded-xl text-left text-xs font-bold ${subTab===x.id?'bg-gray-800 text-white':'bg-white text-gray-500'}`}>{x.l}</button>)}
                                </div>
                                <div className="flex-1 glass-panel p-5 rounded-3xl">
                                    {subTab===1 && <div><div className="bg-red-50 p-4 rounded-xl mb-4 border border-red-100"><h4 className="text-red-600 font-bold text-xs uppercase mb-2">Red Flags</h4><div className="grid grid-cols-1 gap-2">{RED_FLAGS.map(f=><label key={f} className="flex items-center gap-2 text-xs font-medium"><input type="checkbox" checked={data.redFlags.includes(f)} onChange={()=>toggleArr('redFlags',f)} className="accent-red-500"/>{f}</label>)}</div></div><VisceroBox selected={data.viscerosomatic} onToggle={v=>toggleArr('viscerosomatic',v)}/></div>}
                                    {subTab===3 && <div><ClusterBox cluster={CLUSTERS.cervical} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><ClusterBox cluster={CLUSTERS.cervical_myelopathy} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.cervical}/></div>}
                                    {subTab===4 && <div><RomGrid d={ROM_DATA.thoracic}/></div>}
                                    {subTab===5 && <div><ClusterBox cluster={CLUSTERS.lumbar_stenosis} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><ClusterBox cluster={CLUSTERS.lumbar_instability} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.lumbar}/></div>}
                                    {subTab===6 && <div><ClusterBox cluster={CLUSTERS.sij} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/></div>}
                                    {subTab===7 && <div><ClusterBox cluster={CLUSTERS.hip_oa} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.hip}/></div>}
                                </div>
                            </div>}

                            {/* NEURO */}
                            {mainTab === 'Neurological' && <div className="flex flex-col md:flex-row gap-4 animate-fade-in">
                                <div className="md:w-48 flex-shrink-0 flex md:flex-col gap-2 overflow-x-auto pb-2">
                                    {['Screening', 'Conditions', 'Cognitive'].map(t => (
                                        <button key={t} onClick={() => setNeuroTab(t)} className={`px-4 py-3 rounded-xl text-left text-xs font-bold ${neuroTab === t ? 'bg-purple-600 text-white' : 'bg-white text-gray-500'}`}>{t}</button>
                                    ))}
                                </div>
                                <div className="flex-1 glass-panel p-5 rounded-3xl">
                                    {neuroTab === 'Screening' && (
                                        <div className="overflow-x-auto">
                                            <div className="min-w-[500px]">
                                                <div className="grid grid-cols-7 gap-1 text-[10px] font-bold text-gray-400 uppercase text-center mb-2"><div>Lvl</div><div>Derm R</div><div>Derm L</div><div>Myo R</div><div>Myo L</div><div>Reflex R</div><div>Reflex L</div></div>
                                                <h4 className="text-xs font-bold text-gray-800 mb-2 mt-2 border-b">Upper Quarter</h4>
                                                <div className="space-y-1 mb-4">{NEURO_LEVELS.upper.map(l => <NeuroRow key={l} level={l} data={data.neuro} onChange={(k,v)=>update('neuro', k, v)} />)}</div>
                                                <h4 className="text-xs font-bold text-gray-800 mb-2 mt-4 border-b">Lower Quarter</h4>
                                                <div className="space-y-1">{NEURO_LEVELS.lower.map(l => <NeuroRow key={l} level={l} data={data.neuro} onChange={(k,v)=>update('neuro', k, v)} />)}</div>
                                            </div>
                                        </div>
                                    )}
                                    {neuroTab === 'Conditions' && (
                                        <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                            <h4 className="text-xs font-bold text-purple-900 uppercase mb-3 flex items-center gap-2"><Icon name="bolt" /> Common Neuro Patterns</h4>
                                            <div className="space-y-2">
                                                {COMMON_NEURO.map(n => (
                                                    <label key={n} className="flex items-center gap-2 text-xs font-medium cursor-pointer p-2 bg-white rounded border border-purple-100 hover:bg-purple-100 transition-colors">
                                                        <input type="checkbox" className="accent-purple-600" checked={data.commonNeuro.includes(n)} onChange={() => toggleArr('commonNeuro', n)} />
                                                        {n}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {neuroTab === 'Cognitive' && (
                                        <div className="space-y-6">
                                            <div className="bg-yellow-50 p-4 rounded-2xl border border-yellow-100">
                                                <h4 className="text-xs font-bold text-yellow-800 uppercase mb-2">MMSE (Mini-Mental State Exam)</h4>
                                                <div className="flex items-center gap-4">
                                                    <input type="number" max="30" placeholder="Score /30" className="w-24 p-2 rounded-lg border border-yellow-200 text-lg font-bold text-center" value={data.cognitive.mmse} onChange={e => update('cognitive', 'mmse', e.target.value)} />
                                                    <div className="text-xs text-yellow-700">
                                                        <p>24-30: Normal</p>
                                                        <p>18-23: Mild Impairment</p>
                                                        <p>0-17: Severe Impairment</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                                <h4 className="text-xs font-bold text-blue-800 uppercase mb-2">MoCA (Montreal Cognitive Assessment)</h4>
                                                <div className="flex items-center gap-4">
                                                    <input type="number" max="30" placeholder="Score /30" className="w-24 p-2 rounded-lg border border-blue-200 text-lg font-bold text-center" value={data.cognitive.moca} onChange={e => update('cognitive', 'moca', e.target.value)} />
                                                    <div className="text-xs text-blue-700">
                                                        <p>≥ 26: Normal</p>
                                                        <p>&lt; 26: Possible Impairment</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>}

                            {/* EXTREMITIES */}
                            {mainTab === 'Extremities' && <div className="flex flex-col md:flex-row gap-4 animate-fade-in">
                                <div className="md:w-48 flex-shrink-0 flex md:flex-col gap-2 overflow-x-auto pb-2">
                                    {[{id:10,l:'Shoulder'},{id:11,l:'Elbow'},{id:12,l:'Wrist/Hand'},{id:13,l:'Knee'},{id:14,l:'Ankle/Foot'}].map(x=><button key={x.id} onClick={()=>setSubTab(x.id)} className={`px-4 py-3 rounded-xl text-left text-xs font-bold ${subTab===x.id?'bg-gray-800 text-white':'bg-white text-gray-500'}`}>{x.l}</button>)}
                                </div>
                                <div className="flex-1 glass-panel p-5 rounded-3xl">
                                    {subTab===10 && <div><ClusterBox cluster={CLUSTERS.shoulder_imp} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><ClusterBox cluster={CLUSTERS.shoulder_cuff} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><ClusterBox cluster={CLUSTERS.shoulder_instab} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.shoulder}/></div>}
                                    {subTab===11 && <div><ClusterBox cluster={CLUSTERS.elbow_lat} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.elbow}/></div>}
                                    {subTab===12 && <div><ClusterBox cluster={CLUSTERS.wrist_cts} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><ClusterBox cluster={CLUSTERS.wrist_dequervain} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.wrist}/></div>}
                                    {subTab===13 && <div><ClusterBox cluster={CLUSTERS.knee_acl} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><ClusterBox cluster={CLUSTERS.knee_meniscus} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.knee}/></div>}
                                    {subTab===14 && <div><ClusterBox cluster={CLUSTERS.ankle_lat} values={data.tests} onChange={(k,v)=>update('tests',k,v)}/><RomGrid d={ROM_DATA.ankle}/></div>}
                                </div>
                            </div>}

                            {/* ASSESSMENT & EXERCISE GEN */}
                            {mainTab === 'Assessment' && <div className="animate-fade-in space-y-4">
                                <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-2xl border border-indigo-100">
                                    <h3 className="font-bold text-gray-800 uppercase text-xs flex items-center gap-2 mb-3"><Icon name="brain" className="text-purple-500" /> Smart Diagnosis</h3>
                                    {brain.insights.map((ins, i) => (
                                        <div key={i} className={`flex items-start gap-3 p-3 mb-2 rounded-xl bg-white shadow-sm border-l-4 ${ins.type === 'red' ? 'border-red-500' : ins.type === 'orange' ? 'border-orange-500' : 'border-blue-400'}`}>
                                            <div className="text-xs font-bold text-gray-800">{ins.text}</div>
                                        </div>
                                    ))}
                                    {brain.insights.length === 0 && <div className="text-gray-400 text-xs italic">Complete tests to generate diagnosis...</div>}
                                </div>

                                <PsfsModule data={data} update={setData} />

                                <div className="glass-panel p-5 rounded-3xl">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-800 uppercase text-xs flex items-center gap-2"><Icon name="person-walking" /> Patient Home Exercises</h3>
                                        <button onClick={autoFillExercises} className="text-[10px] bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold hover:bg-green-200 transition-colors"><Icon name="wand-magic-sparkles" /> Auto-Fill</button>
                                    </div>
                                    <div className="space-y-2 mb-4">
                                        {data.exercises.length === 0 ? <div className="text-center p-6 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 text-xs">No exercises added yet.</div> : data.exercises.map((ex, idx) => <ExerciseRow key={idx} ex={ex} index={idx} onUpdate={updateExercise} onDelete={removeExercise} />)}
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                        <label className="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Add Manual Exercise</label>
                                        <div className="flex gap-2">
                                            <input className="flex-1 bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500" placeholder="e.g. Wall Slides" value={newExercise} onChange={e => setNewExercise(e.target.value)} onKeyDown={e => e.key === 'Enter' && addExercise(newExercise)} />
                                            <button onClick={() => addExercise(newExercise)} className="bg-gray-800 text-white px-4 rounded-lg text-xs font-bold hover:bg-black">Add</button>
                                        </div>
                                        <div className="mt-3 flex gap-2 overflow-x-auto pb-2">{Object.keys(EXERCISE_DB).map(cat => (<div key={cat}><span className="text-[10px] font-bold text-gray-400 uppercase mr-1">{cat}:</span>{EXERCISE_DB[cat].map(ex => (<button key={ex} onClick={() => addExercise(ex)} className="inline-block bg-white border border-gray-200 rounded px-2 py-1 text-[10px] text-gray-600 mr-1 mb-1 hover:bg-blue-50 hover:border-blue-200 transition-colors">{ex}</button>))}</div>))}</div>
                                    </div>
                                </div>

                                <div className="glass-panel p-5 rounded-3xl">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-gray-800 uppercase text-xs">Treatment Plan</h3>
                                        <div className="flex gap-2">
                                            <DictationButton onResult={t => setData({...data, treatmentNotes: (data.treatmentNotes ? data.treatmentNotes + ' ' : '') + t})} />
                                            <button onClick={() => setShowLetter(true)} className="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow hover:bg-indigo-700">Write Referral</button>
                                            <button onClick={() => setShowReport(true)} className="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow hover:bg-blue-700">Generate Report</button>
                                        </div>
                                    </div>
                                    <textarea className="w-full bg-gray-50 rounded-xl p-4 text-sm outline-none h-32 border border-gray-200" placeholder="Specific manual therapy details..." value={data.treatmentNotes} onChange={e=>setData({...data, treatmentNotes:e.target.value})}/>
                                </div>
                            </div>}

                            {/* POST ASSESSMENT */}
                            {mainTab === 'Post Assessment' && <div className="glass-panel p-5 rounded-3xl animate-fade-in space-y-6">
                                <div className="flex items-center justify-between">
                                    <span className="text-xs font-bold text-gray-400 uppercase">Post-Rx Status</span>
                                    <div className="flex gap-2">{['Better','Same','Worse'].map(s=><button key={s} onClick={()=>setData({...data, postStatus:s})} className={`px-4 py-2 rounded-xl text-xs font-bold ${data.postStatus===s?(s==='Better'?'bg-green-500 text-white':s==='Worse'?'bg-red-500 text-white':'bg-gray-500 text-white'):'bg-gray-100 text-gray-500'}`}>{s}</button>)}</div>
                                </div>
                                <div className="flex justify-between gap-4"><div className="w-1/2"><SmileyVAS value={data.vas} onChange={v => setData({...data, vas:v})} label="Pre-Rx" /></div><div className="w-1/2"><SmileyVAS value={data.postVas} onChange={v => setData({...data, postVas:v})} label="Post-Rx" /></div></div>
                                <textarea className="w-full bg-gray-50 rounded-xl p-4 text-sm outline-none h-32 border border-gray-200" placeholder="Objective changes and follow up plan..." value={data.postNotes} onChange={e=>setData({...data, postNotes:e.target.value})}/>
                            </div>}
                        </div>
                    </div>

                    {showReport && <ReportModal data={data} insights={brain.insights} onClose={() => setShowReport(false)} />}
                    {showLetter && <LetterModal data={data} insights={brain.insights} onClose={() => setShowLetter(false)} />}
                    {showManager && <PatientManager current={data} onLoad={setData} onNew={clearData} onClose={() => setShowManager(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AssessmentApp />);
    </script>
</body>
</html>